<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <title>Pagamento PIX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0b1020; --card:#11162a; --text:#f4f6fb; --muted:#c1c7d3;
      --brand:#39b885; --brand-2:#4f7cff; --shadow:0 16px 50px rgba(0,0,0,.38);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f3f5f9; --card:#ffffff; --text:#0e1320; --muted:#5b6473; --shadow:0 12px 28px rgba(10,36,99,.12) }
    }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background:
        radial-gradient(1100px 1100px at -10% -10%, rgba(57,184,133,.18), transparent 40%),
        radial-gradient(1200px 1200px at 110% 10%, rgba(79,124,255,.16), transparent 40%),
        var(--bg);
      min-height:100dvh; display:grid; place-items:center; padding:28px 18px;
      color:var(--text); font:16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    }
    .card{
      width:min(760px, 96vw); background:var(--card); box-shadow:var(--shadow);
      border-radius:22px; padding:26px 22px; position:relative; overflow:hidden;
      outline:1px solid rgba(255,255,255,.06);
    }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap }
    .title{ display:flex; align-items:center; gap:12px }
    .ring{
      width:38px; height:38px; border-radius:50%;
      background:radial-gradient(circle at 30% 25%, #4f7cff, #39b885);
      box-shadow:0 0 0 4px rgba(79,124,255,.15);
    }
    h1{ margin:0; font-size:clamp(20px, 2.2vw, 26px) }
    .muted{ color:var(--muted) }

    .grid{
      display:grid; grid-template-columns: 1fr 1.1fr; gap:22px; margin-top:18px;
    }
    @media (max-width: 820px){ .grid{ grid-template-columns: 1fr } }

    .panel{
      background:rgba(255,255,255,.04); border-radius:16px; padding:16px;
      outline:1px solid rgba(255,255,255,.06);
    }

    .qr{ display:grid; place-items:center; }
    .qr img{ width:min(320px, 70vw); aspect-ratio:1/1; object-fit:contain; border-radius:12px; }

    .price{
      margin:6px 0 14px; font-size:clamp(22px, 3.8vw, 30px); font-weight:800;
      background:linear-gradient(90deg, #39b885, #4f7cff); -webkit-background-clip:text; background-clip:text;
      color:transparent; letter-spacing:.3px;
    }

    .code{
      background:#0c1224; color:#eaf0ff; border-radius:12px; padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:.92rem; word-break:break-all; line-height:1.4; position:relative;
      outline:1px solid rgba(255,255,255,.06);
    }
    @media (prefers-color-scheme: light){ .code{ background:#f5f7fc; color:#0e1320 } }

    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .btn{
      appearance:none; border:0; cursor:pointer; text-decoration:none;
      display:inline-flex; align-items:center; gap:10px; padding:12px 14px;
      border-radius:12px; font-weight:800; color:#07132a; background:#e8fff6;
      transition:transform .12s ease, box-shadow .12s ease; box-shadow:0 10px 18px rgba(57,184,133,.22);
    }
    .btn:hover{ transform:translateY(-1px) }
    .btn.primary{ background:linear-gradient(135deg, #39b885, #2aa16f); color:#ffffff; box-shadow:0 12px 22px rgba(57,184,133,.28) }
    .btn.secondary{ background:linear-gradient(135deg, #4f7cff, #3f5eea); color:#fff; box-shadow:0 12px 22px rgba(79,124,255,.28) }
    .btn.ghost{ background:linear-gradient(135deg, #2f384a, #202535); color:#e7ebf6; box-shadow:none }

    .meta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .chip{
      padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06);
      color:#e2e7f5; font-weight:700; font-size:.85rem; letter-spacing:.2px;
    }

    .timer{
      display:flex; align-items:center; gap:10px; margin-top:8px;
      padding:10px 12px; border-radius:12px; background:rgba(255,255,255,.04);
      outline:1px solid rgba(255,255,255,.06); color:#e2e7f5; font-weight:700;
    }
    .timer .dot{
      width:10px; height:10px; border-radius:50%; background:#39b885;
      box-shadow:0 0 0 0 rgba(57,184,133,.55); animation: pulse 1.6s infinite;
    }
    @keyframes pulse { to { box-shadow:0 0 0 10px rgba(57,184,133,0) } }

    .foot{
      margin-top:16px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--muted); font-size:.92rem;
    }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
  </style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="title">
        <span class="ring" aria-hidden="true"></span>
        <div>
          <h1>Finalize com PIX</h1>
          <div class="muted">Escaneie o QR ou copie o c√≥digo PIX para pagar.</div>
        </div>
      </div>
      <div class="meta">
        <span class="chip">Inscri√ß√£o #{{ inscricao.id }}</span>
        <span class="chip">Evento: {{ inscricao.evento.nome }}</span>
      </div>
    </div>

    <div class="grid">
      <section class="panel qr" aria-label="QR Code PIX">
        {% if qr_code_base64 %}
          <img src="data:image/png;base64,{{ qr_code_base64 }}" alt="QR Code PIX"/>
        {% endif %}
        <div class="timer" id="timer" aria-live="polite">
          <span class="dot" aria-hidden="true"></span>
          Expira em <span class="mono" id="countdown">--:--</span>
        </div>
      </section>

      <section class="panel" aria-label="Detalhes do pagamento">
        <div class="price">R$ {{ valor|floatformat:2 }}</div>

        {% if qr_code_text %}
          <div class="code" id="pix-code" aria-label="C√≥digo PIX copia e cola">{{ qr_code_text }}</div>
          <div class="row">
            <button class="btn primary" id="copy-btn" type="button">üìã Copiar c√≥digo</button>
            {% if ticket_url %}
              <a class="btn secondary" href="{{ ticket_url }}" target="_blank" rel="noopener">üîé Ver no Mercado Pago</a>
            {% endif %}
            <a class="btn ghost" href="{% url 'inscricoes:ver_inscricao' inscricao.id %}">‚Ü©Ô∏è Voltar √† inscri√ß√£o</a>
          </div>
        {% endif %}

        <p class="muted" style="margin-top:12px">
          Assim que o pagamento for identificado, voc√™ ser√° redirecionado automaticamente.
        </p>
      </section>
    </div>

    <div class="foot">
      <span>Pagamento seguro por Mercado Pago</span>
      <span class="mono">ID: {{ payment_id }}</span>
    </div>
  </div>

  <script>
    // Copiar c√≥digo
    const btn = document.getElementById('copy-btn');
    btn?.addEventListener('click', async () => {
      const code = document.getElementById('pix-code').innerText;
      try {
        await navigator.clipboard.writeText(code);
        btn.textContent = '‚úÖ Copiado!';
        setTimeout(() => btn.textContent = 'üìã Copiar c√≥digo', 1800);
      } catch(e) {
        btn.textContent = 'Tente novamente';
        setTimeout(() => btn.textContent = 'üìã Copiar c√≥digo', 1800);
      }
    });

    // Countdown at√© expires_at (ISO UTC ‚ÄúYYYY-MM-DDTHH:MM:SS.000Z‚Äù)
    const expiresAt = "{{ expires_at|escapejs }}";
    const countdownEl = document.getElementById('countdown');
    function two(n){ return n < 10 ? '0'+n : n }
    function tick(){
      try{
        const end = new Date(expiresAt).getTime();
        const now = Date.now();
        const diff = Math.max(0, Math.floor((end - now)/1000));
        const m = Math.floor(diff/60), s = diff%60;
        countdownEl.textContent = `${two(m)}:${two(s)}`;
        if (diff === 0) { countdownEl.textContent = 'expirado'; return; }
        setTimeout(tick, 500);
      }catch(e){ countdownEl.textContent = '--:--' }
    }
    tick();

    // Polling de status
    const inscricaoId = "{{ inscricao.id }}";
    async function checar() {
      try {
        const r = await fetch(`/api/pagamento/status/${inscricaoId}/`, { cache: "no-store" });
        if (!r.ok) throw new Error();
        const j = await r.json();
        if (j.status === "confirmado") {
          window.location.href = `/pagamento/sucesso/{{ inscricao.id }}/`;
          return;
        }
        if (j.status === "cancelado") {
          window.location.href = `/pagamento/falha/{{ inscricao.id }}/`;
          return;
        }
      } catch(e) {}
      setTimeout(checar, 5000);
    }
    setTimeout(checar, 5000);
  </script>
</body>
</html>
