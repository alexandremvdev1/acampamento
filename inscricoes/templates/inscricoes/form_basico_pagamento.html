{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Inscrição - {{ evento.nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root{ --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --head:#f8fafc; --bg:#f6f8fb; --primary:#0d6efd; }
    *{ box-sizing:border-box; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,system-ui,sans-serif;
      max-width:960px; margin:24px auto; padding:16px;
      color:var(--ink); background:var(--bg); position:relative;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background-image:url("{% if politica and politica.imagem_2 %}{{ politica.imagem_2.url }}{% else %}{% static 'img/bg-default.jpg' %}{% endif %}");
      background-size:cover; background-position:center;
      filter:blur(6px) saturate(0.8); opacity:.18;
    }
    header{ text-align:center; margin-bottom:16px; }
    header img{ max-width:100%; border-radius:12px; margin-bottom:10px; box-shadow:0 6px 18px rgba(2,6,23,.15); }
    header h1{ font-size:clamp(1.25rem,2.2vw,1.6rem); margin:0 0 4px; color:#111827; }
    header p{ color:var(--muted); margin:0; }

    .form-card{ background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 10px 24px rgba(17,24,39,.08); padding:18px 16px; }
    fieldset{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:14px 14px 10px; margin:0 0 16px; }
    legend{ font-size:.95rem; font-weight:800; margin:0 8px; padding:0 6px; color:#0b1324; background:var(--head); border:1px solid var(--line); border-radius:8px; }

    .form-compact input, .form-compact select, .form-compact textarea{
      display:block; width:100%; font-size:.92rem; line-height:1.25; padding:.45rem .6rem;
      border:1px solid #cbd5e1; border-radius:.5rem; background:#fff; color:#0f172a;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .form-compact input:focus, .form-compact select:focus, .form-compact textarea:focus{
      outline:none; border-color:var(--primary); box-shadow:0 0 0 .18rem rgba(13,110,253,.15);
    }
    .form-compact label{ font-size:.82rem; font-weight:700; color:#111827; margin:6px 0 4px; display:block; }
    .help-text{ font-size:.78rem; color:var(--muted); }
    .g-compact{ --bs-gutter-x:.6rem; --bs-gutter-y:.5rem; }
    .divider{ border:0; border-top:1px dashed #e5e7eb; margin:.6rem 0 1rem; }

    .btn-primary-compact{
      background:var(--primary); border:1px solid #0b5ed7; color:#fff; font-weight:800; font-size:.95rem; padding:.55rem .9rem; border-radius:.6rem;
      transition: transform .05s ease, box-shadow .15s ease, background .15s ease;
    }
    .btn-primary-compact:hover{ background:#0b5ed7; box-shadow:0 6px 14px rgba(13,110,253,.25); }

    input#id_nome, input#id_cidade{ text-transform: capitalize; }

    /* WhatsApp flutuante */
    #whatsapp-flutuante{
      position: fixed; bottom: 20px; right: 20px;
      background-color: #ffffff; width: 60px; height: 60px; border-radius: 50%;
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      z-index: 1100; user-select: none;
      transition: transform .15s ease, box-shadow .15s ease, background-color .3s ease;
    }
    #whatsapp-flutuante:hover{ transform: scale(1.06); box-shadow: 0 6px 16px rgba(0,0,0,.35); }
    #whatsapp-flutuante img{ width:100%; height:100%; object-fit:cover; border-radius:50%; display:block; }

    .modal-lite{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);
      justify-content:center; align-items:center; z-index:2200; padding:12px;
    }
    .modal-lite.show{ display:flex; }
    .modal-content-lite{
      background:#fff; border-radius:12px; padding:18px; max-width:640px; width:100%;
      max-height:90vh; overflow:auto; position:relative; border:1px solid #e5e7eb;
      box-shadow:0 14px 34px rgba(2,6,23,.25); text-align:center;
    }
    .close-lite{ position:absolute; right:10px; top:6px; font-size:26px; cursor:pointer; color:#9ca3af; }
    .close-lite:hover{ color:#111827; }
    .btn-whatsapp{ background:#25D366; color:#fff; border:none; border-radius:.6rem; padding:.6rem 1rem; font-size:1rem; font-weight:800; text-decoration:none; display:inline-block; }
    .btn-whatsapp:hover{ background:#128C4A; }
  </style>
</head>
<body>
  <header>
    {% if evento.banner %}<img src="{{ evento.banner.url }}" alt="Banner {{ evento.nome }}">{% endif %}
    <h1>{{ evento.nome }}</h1>
    {% if evento.data_inicio and evento.data_fim %}
      <p><strong>Data:</strong> {{ evento.data_inicio|date:"d/m/Y" }} - {{ evento.data_fim|date:"d/m/Y" }}</p>
    {% endif %}
  </header>

  {% if messages %}
    <div class="mb-2">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} mb-2">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="form-card">
    <form class="form-compact" method="post" novalidate>
      {% csrf_token %}
      {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}

      <fieldset>
        <legend>Dados do Participante</legend>

        <div class="row g-compact">
          <div class="col-md-8">
            <label for="id_nome">Nome completo</label>
            {{ form.nome }}
            <div class="text-danger small">{{ form.nome.errors }}</div>
          </div>
          <div class="col-md-4">
            <label for="id_cpf">CPF</label>
            {{ form.cpf }}
            <div class="text-danger small">{{ form.cpf.errors }}</div>
          </div>
        </div>

        <div class="row g-compact mt-2">
          <div class="col-md-4">
            <label for="id_CEP">CEP</label>
            {{ form.CEP }}
            <div class="help-text">Digite o CEP para preencher cidade e UF automaticamente.</div>
            <div class="text-danger small">{{ form.CEP.errors }}</div>
          </div>
          <div class="col-md-5">
            <label for="id_cidade">Cidade (preenchida pelo CEP)</label>
            {{ form.cidade }}
            <div class="help-text">Campo travado: altere o CEP para mudar a cidade.</div>
            <div class="text-danger small">{{ form.cidade.errors }}</div>
          </div>
          <div class="col-md-3">
            <label for="id_estado">Estado (UF)</label>
            {{ form.estado }}
            <div class="help-text">Preenchido pelo CEP.</div>
            <div class="text-danger small">{{ form.estado.errors }}</div>
          </div>
        </div>
      </fieldset>

      <div class="d-flex justify-content-center">
        <button type="submit" class="btn-primary-compact">
          <i class="fa-solid fa-circle-check me-1"></i> Criar e Realizar Pagamento
        </button>
      </div>
    </form>
  </div>

  <p class="text-center mt-2 fw-semibold">
    <a href="#" onclick="openModal('modalPolitica')">Política de Privacidade</a>
  </p>
  <footer class="text-center" style="font-size:.75rem; color:#9aa3b2;">eismeaqui.app - Desenvolvido por Alexandre Martins Vieira 2025 ©</footer>

  <!-- Modal Política -->
  <div id="modalPolitica" class="modal-lite" aria-hidden="true">
    <div class="modal-content-lite">
      <span class="close-lite" onclick="closeModal('modalPolitica')">&times;</span>
      <h3 class="mb-2">Política de Privacidade</h3>
      {% if politica and politica.texto %}<div class="text-start">{{ politica.texto|linebreaks }}</div>{% else %}<p>Política de privacidade indisponível.</p>{% endif %}
    </div>
  </div>

  <!-- Botão flutuante WhatsApp -->
  <div id="whatsapp-flutuante" title="Fale conosco pelo WhatsApp" onclick="openModal('modalWhatsApp')" role="button" aria-label="Ajuda via WhatsApp">
    {% if politica and politica.imagem_ajuda %}
      <img src="{{ politica.imagem_ajuda.url }}" alt="Ajuda" width="60" height="60" loading="lazy">
    {% else %}
      <img src="{% static 'img/ajuda/porquinho.png' %}" alt="Ajuda" width="60" height="60" loading="lazy">
    {% endif %}
  </div>

  <!-- Modal WhatsApp -->
  <div id="modalWhatsApp" class="modal-lite" aria-hidden="true">
    <div class="modal-content-lite">
      <span class="close-lite" onclick="closeModal('modalWhatsApp')">&times;</span>
      <h3>Fale conosco pelo WhatsApp</h3>
      <p class="mb-3">Estamos prontos para ajudar você!</p>
      <a href="https://wa.me/5511999999999" target="_blank" class="btn-whatsapp">
        <i class="fa-brands fa-whatsapp me-1"></i> Abrir WhatsApp
      </a>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.9/dist/inputmask.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Força classes Bootstrap nos widgets Django
    document.addEventListener('DOMContentLoaded', function () {
      const sel = 'input:not([type=checkbox]):not([type=radio]):not([type=file]), select, textarea';
      document.querySelectorAll(sel).forEach(el => el.classList.add('form-control','form-control-sm'));
    });

    // Modais (lite)
    function openModal(id){ document.getElementById(id)?.classList.add('show'); }
    function closeModal(id){ document.getElementById(id)?.classList.remove('show'); }
    window.addEventListener('click', e => {
      if (e.target.classList?.contains('modal-lite')) closeModal(e.target.id);
    });
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') document.querySelectorAll('.modal-lite.show').forEach(m => m.classList.remove('show'));
    });

    // Máscaras
    document.addEventListener('DOMContentLoaded', function () {
      if (window.Inputmask) {
        if (document.getElementById('id_cpf')) Inputmask("999.999.999-99").mask("#id_cpf");
        if (document.getElementById('id_CEP')) Inputmask("99999-999").mask("#id_CEP");
      }
    });

    function onlyDigits(s){ return (s||"").replace(/\D/g,''); }

    // Travar Cidade (sempre readonly)
    document.addEventListener('DOMContentLoaded', function(){
      const cidadeEl = document.getElementById('id_cidade');
      if (cidadeEl){
        cidadeEl.setAttribute('readonly','readonly');
        cidadeEl.addEventListener('keydown', e => e.preventDefault());
        cidadeEl.addEventListener('paste',  e => e.preventDefault());
      }
    });

    // Tornar UF não-editável, mas garantindo envio ao backend
    document.addEventListener('DOMContentLoaded', function(){
      const ufEl = document.getElementById('id_estado');
      if (!ufEl) return;

      if (ufEl.tagName === 'SELECT') {
        ufEl.setAttribute('disabled','disabled');
        // cria hidden para enviar o valor
        let hidden = document.getElementById('id_estado_hidden_submit');
        if (!hidden) {
          hidden = document.createElement('input');
          hidden.type = 'hidden';
          hidden.id = 'id_estado_hidden_submit';
          hidden.name = ufEl.name; // mesmo nome esperado no backend
          ufEl.closest('form').appendChild(hidden);
        }
        // sincroniza sempre que mudar (via CEP)
        const sync = ()=> hidden.value = ufEl.value || '';
        ufEl.addEventListener('change', sync);
        sync();
      } else {
        // input text: usar readonly (envia normalmente)
        ufEl.setAttribute('readonly','readonly');
        ufEl.addEventListener('keydown', e => e.preventDefault());
        ufEl.addEventListener('paste',  e => e.preventDefault());
      }
    });

    // ViaCEP → preenche Cidade e UF
    async function preencherPorCEP(raw){
      const cep = onlyDigits(raw);
      const cidadeEl = document.getElementById('id_cidade');
      const ufEl     = document.getElementById('id_estado');
      const ufHidden = document.getElementById('id_estado_hidden_submit');

      if(!cidadeEl || !ufEl) return;

      if(cep.length !== 8){
        cidadeEl.value = '';
        if (ufEl.tagName === 'SELECT') { ufEl.value = ''; if (ufHidden) ufHidden.value = ''; }
        else { ufEl.value = ''; }
        return;
      }

      try{
        const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        if(!resp.ok) return;
        const data = await resp.json();
        if(data && !data.erro){
          // cidade
          cidadeEl.value = data.localidade || '';

          // UF (select ou input)
          const uf = (data.uf || '').toUpperCase();

          if (ufEl.tagName === 'SELECT') {
            // tenta selecionar a opção correspondente
            const opt = Array.from(ufEl.options).find(o => (o.value || o.textContent).toUpperCase() === uf);
            ufEl.value = opt ? opt.value : '';
            if (ufHidden) ufHidden.value = ufEl.value || '';
            ufEl.dispatchEvent(new Event('change', { bubbles:true }));
          } else {
            ufEl.value = uf;
          }
        } else {
          cidadeEl.value = '';
          if (ufEl.tagName === 'SELECT') { ufEl.value = ''; if (ufHidden) ufHidden.value = ''; }
          else { ufEl.value = ''; }
        }
      }catch(_){
        cidadeEl.value = '';
        if (ufEl.tagName === 'SELECT') { ufEl.value = ''; if (ufHidden) ufHidden.value = ''; }
        else { ufEl.value = ''; }
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      const cepEl = document.getElementById('id_CEP');
      if(cepEl){
        const trigger = () => {
          const d = onlyDigits(cepEl.value);
          if (d.length === 8) preencherPorCEP(cepEl.value);
        };
        cepEl.addEventListener('blur', trigger);
        cepEl.addEventListener('input', trigger);
      }
    });

    // Title Case p/ Nome
    (function(){
      function isLetter(ch){ return /[A-Za-zÀ-ÿ]/.test(ch); }
      function isMostlyUppercase(str){
        let letters=0, upper=0;
        for(const ch of str){ if(isLetter(ch)){ letters++; if(ch === ch.toUpperCase()) upper++; } }
        return letters>0 && (upper/letters) >= 0.8;
      }
      function titleCaseName(raw){
        if(!raw) return "";
        let s = raw.trim().replace(/\s+/g," ");
        if(isMostlyUppercase(s)) s = s.toLowerCase();
        const LOWER_KEEP = new Set(["de","da","do","dos","das","e"]);
        return s.split(" ").map((w,i)=>{
          const base = w.toLowerCase();
          if(i>0 && LOWER_KEEP.has(base)) return base;
          return base.charAt(0).toUpperCase()+base.slice(1);
        }).join(" ");
      }
      const nome = document.getElementById('id_nome');
      if(nome){
        const fix = ()=>{ const t=titleCaseName(nome.value||""); if(nome.value!==t) nome.value=t; };
        nome.addEventListener('blur', fix);
        nome.form?.addEventListener('submit', fix);
      }
    })();
  </script>
</body>
</html>
