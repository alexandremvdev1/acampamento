{% load static %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Relatório de Inscritos — {{ evento.nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff; margin:0; }
      body *{ visibility:hidden; }
      #printHeader, #printHeader *{ visibility:visible; }
      #printHeader{ position:absolute; inset:0 auto auto 0; width:100%; text-align:center; font-weight:700; font-size:14px; padding:.5rem 0; }
      #tRelatorio, #tRelatorio *{ visibility:visible; }
      #tRelatorio{ position:absolute; left:0; top:40px; width:100%; }
      #tRelatorio thead, #tRelatorio tfoot{ display:none !important; }
      #tRelatorio td{ padding:.4rem .5rem; font-size:12px; }
      .sticky-topbar{ display:none !important; }
    }
    :root{ --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --panel:#fff; --shadow:0 10px 24px rgba(17,24,39,.08); --base-font:14px; }
    html{ font-size: var(--base-font); }
    body{ background:#f6f8fb; color:var(--ink); }
    .nav-pro{ background:linear-gradient(90deg,#0b1020,#111a3a); }
    .sticky-topbar{ position: sticky; top: 0; z-index: 20; background:#ffffffd6; backdrop-filter: blur(6px); border:1px solid var(--line); border-radius:.9rem; }
    .text-muted-2{ color:var(--muted); }
    .card-clean{ border:1px solid var(--line); border-radius:.95rem; background:#fff; box-shadow:var(--shadow); }
    .sec-title{ font-size:.95rem; color:var(--muted); font-weight:700; margin:0 0 .75rem; text-transform:uppercase; }
    #tRelatorio thead th{ position:sticky; top:0; z-index:5; background:linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,0)); }
    .is-hidden{ display:none !important; }
    .chip{ border:1px solid var(--line); border-radius:999px; padding:.5rem .9rem; background:#fff; font-weight:700; box-shadow:var(--shadow); }
  </style>
</head>
<body>
<nav class="navbar nav-pro navbar-dark no-print">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'inscricoes:relatorios_evento' evento.id %}">
      <i class="fa-solid fa-arrow-left me-2"></i> Relatórios
    </a>
    <span class="navbar-text text-white-50 d-none d-md-inline">{{ evento.nome }}</span>
    <div class="d-flex gap-2 ms-auto">
      <button id="btnImprimirTopo" class="btn btn-light btn-sm">
        <i class="fa-solid fa-print me-1"></i> Imprimir
      </button>
    </div>
  </div>
</nav>

<main class="container py-3" id="page" data-evento="{{ evento.id }}">
  <div class="sticky-topbar p-3 mb-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <h1 class="h6 m-0">Relatório de Inscritos</h1>
        <div class="small text-muted-2">
          {{ evento.nome }} • Total: <strong>{{ rows|length }}</strong>
        </div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'inscricoes:relatorios_evento' evento.id %}">
          <i class="fa fa-arrow-left me-1"></i> Voltar para Relatórios
        </a>
        <button class="btn btn-primary btn-sm" id="btnImprimir2"><i class="fa fa-print me-1"></i> Imprimir</button>
        <button class="btn btn-outline-primary btn-sm" id="btnExcel2"><i class="fa fa-file-excel me-1"></i> Baixar CSV</button>
      </div>
    </div>
  </div>

  <div id="printHeader">Relatório de Inscritos — {{ evento.nome }}</div>

  <!-- Filtros -->
  <form method="get" class="card-clean p-3 p-md-4 mb-3 no-print" id="formFiltros">
    <h2 class="sec-title"><i class="fa-solid fa-sliders"></i> Filtros</h2>
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-3">
        <label for="cidade" class="form-label small text-muted">Filtrar por cidade</label>
        <select name="cidade" id="cidade" class="form-select">
          <option value="">Todas</option>
          {% for c in cidades %}
            <option value="{{ c }}" {% if cidade_filtro == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label for="status" class="form-label small text-muted">Status da inscrição</label>
        <select name="status" id="status" class="form-select">
          <option value="">Todos</option>
          <option value="concluida" {% if status_filtro == 'concluida' %}selected{% endif %}>Concluída</option>
          <option value="pendente"  {% if status_filtro == 'pendente'  %}selected{% endif %}>Pendente</option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label for="selecionado" class="form-label small text-muted">Selecionado</label>
        <select name="selecionado" id="selecionado" class="form-select">
          <option value="">Todos</option>
          <option value="sim" {% if selecionado_filtro == 'sim' %}selected{% endif %}>Apenas selecionados</option>
          <option value="nao" {% if selecionado_filtro == 'nao' %}selected{% endif %}>Não selecionados</option>
        </select>
      </div>

      {% if casais_mode %}
      <div class="col-12 col-md-3">
        <label for="casado_igreja" class="form-label small text-muted">Casado na Igreja?</label>
        <select name="casado_igreja" id="casado_igreja" class="form-select">
          <option value="">Todos</option>
          <option value="sim" {% if casado_igreja_filtro == 'sim' %}selected{% endif %}>Sim</option>
          <option value="nao" {% if casado_igreja_filtro == 'nao' %}selected{% endif %}>Não</option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label for="tempo_casados" class="form-label small text-muted">Tempo de casados</label>
        <input type="text" id="tempo_casados" name="tempo_casados" value="{{ tempo_casados_filtro }}" class="form-control" placeholder="Ex.: 10 anos">
      </div>
      {% endif %}

      <div class="col-12 d-grid d-md-flex justify-content-md-center mt-2">
        <button class="btn btn-primary btn-sm px-4" type="submit">
          <i class="fa fa-filter me-2"></i>Aplicar filtros
        </button>
      </div>
    </div>
  </form>

  <!-- Seleção de colunas -->
  <section class="card-clean p-3 p-md-4 mb-3 no-print">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h2 class="sec-title mb-0"><i class="fa-solid fa-table-columns"></i> Colunas</h2>
      <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#colsCollapse" aria-expanded="true">
        Mostrar / ocultar
      </button>
    </div>

    <div class="collapse show mt-3" id="colsCollapse">
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-6 g-2" id="colsGrid">
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-idx"> <span class="form-check-label">#</span></label></div>
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-nome" checked> <span class="form-check-label">Nome</span></label></div>
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-cidade" checked> <span class="form-check-label">Cidade</span></label></div>
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-estado"> <span class="form-check-label">Estado</span></label></div>
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-telefone"> <span class="form-check-label">Telefone</span></label></div>
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-email"> <span class="form-check-label">E-mail</span></label></div>
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-camisa" checked> <span class="form-check-label">Tamanho da Camisa</span></label></div>
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-nasc" checked> <span class="form-check-label">Data de Nascimento</span></label></div>
        {% if casais_mode %}
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-tempo" checked> <span class="form-check-label">Tempo Casados</span></label></div>
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-igreja" checked> <span class="form-check-label">Casado na Igreja</span></label></div>
        {% endif %}
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-status" checked> <span class="form-check-label">Status</span></label></div>
        <div class="col"><label class="form-check"><input type="checkbox" class="form-check-input col-toggle" data-col="col-selecionado"> <span class="form-check-label">Selecionado</span></label></div>
      </div>

      <div class="d-flex flex-wrap gap-2 mt-3">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="btnMarcarTodos">Selecionar tudo</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="btnLimpar">Limpar</button>
        <button type="button" class="btn btn-success btn-sm" id="btnImprimir"><i class="fa fa-print me-2"></i>Imprimir</button>
        <button type="button" class="btn btn-outline-primary btn-sm" id="btnExcel"><i class="fa fa-file-excel me-2"></i>Baixar CSV</button>
      </div>
    </div>
  </section>

  <!-- Tabela -->
  <section class="card-clean p-2 p-md-3">
    <div class="table-responsive">
      <table id="tRelatorio" class="table table-hover align-middle" aria-label="Tabela de inscritos">
        <thead>
          <tr>
            <th class="col-idx">#</th>
            <th class="col-nome">Nome</th>
            <th class="col-cidade">Cidade</th>
            <th class="col-estado">Estado</th>
            <th class="col-telefone">Telefone</th>
            <th class="col-email">E-mail</th>
            <th class="col-camisa">Tamanho da Camisa</th>
            <th class="col-nasc">Data de Nascimento</th>
            {% if casais_mode %}
              <th class="col-tempo">Tempo Casados</th>
              <th class="col-igreja">Casado na Igreja</th>
            {% endif %}
            <th class="col-status">Status</th>
            <th class="col-selecionado">Selecionado</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              <td class="col-idx">{{ forloop.counter }}</td>
              <td class="col-nome">{{ r.nome }}</td>
              <td class="col-cidade">{{ r.cidade }}</td>
              <td class="col-estado">{{ r.estado }}</td>
              <td class="col-telefone">{{ r.telefone }}</td>
              <td class="col-email">{{ r.email }}</td>
              <td class="col-camisa">{{ r.camisa|default:"-" }}</td>
              <td class="col-nasc">{% if r.nasc %}{{ r.nasc|date:"d/m/Y" }}{% else %}-{% endif %}</td>

              {% if casais_mode %}
                <td class="col-tempo">{{ r.tempo_casado|default:"-" }}</td>
                <td class="col-igreja">
                  {% if r.casado_na_igreja is not None %}
                    {% if r.casado_na_igreja %}Sim{% else %}Não{% endif %}
                  {% else %}-{% endif %}
                </td>
              {% endif %}

              <td class="col-status">{{ r.status_label }}</td>
              <td class="col-selecionado">{% if r.selecionado %}Sim{% else %}Não{% endif %}</td>
            </tr>
          {% empty %}
            <tr><td class="text-muted" colspan="{% if casais_mode %}12{% else %}10{% endif %}">Nenhum participante encontrado.</td></tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <td class="text-muted small" colspan="{% if casais_mode %}12{% else %}10{% endif %}">Gerado em {{ now }}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <div class="text-end text-body fw-bold mt-2 no-print">
    Total de linhas: {{ rows|length }}
  </div>

  <!-- Quantidade de camisas -->
  <section class="no-print mt-3">
    <div class="d-flex flex-wrap gap-2" aria-label="Quantidade de camisas por tamanho">
      <span class="chip">PP:  {{ quantidades_camisas.pp|default_if_none:0 }}</span>
      <span class="chip">P:   {{ quantidades_camisas.p|default_if_none:0 }}</span>
      <span class="chip">M:   {{ quantidades_camisas.m|default_if_none:0 }}</span>
      <span class="chip">G:   {{ quantidades_camisas.g|default_if_none:0 }}</span>
      <span class="chip">GG:  {{ quantidades_camisas.gg|default_if_none:0 }}</span>
      <span class="chip">XG:  {{ quantidades_camisas.xg|default_if_none:0 }}</span>
      <span class="chip">XGG: {{ quantidades_camisas.xgg|default_if_none:0 }}</span>
    </div>
  </section>

  <footer class="py-3">
    <div class="d-flex flex-wrap justify-content-between align-items-center">
      <small>© {{ now|date:"Y" }} — Todos os direitos reservados</small>
      <small class="text-muted-2">Desenvolvido por Alexandre Martins Vieira • Bootstrap 5</small>
    </div>
  </footer>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(function(){
  const table      = document.getElementById('tRelatorio');
  const eventoId   = document.getElementById('page').dataset.evento || '0';
  const checkboxes = Array.from(document.querySelectorAll('.col-toggle'));

  const allCols = [
    'col-idx','col-nome','col-cidade','col-estado','col-telefone',
    'col-email','col-camisa','col-nasc','col-status','col-selecionado',
    'col-tempo','col-igreja'
  ];

  function applyColumns(active){
    const toHide = allCols.filter(c => !active.includes(c));
    const toShow = active.slice();
    toHide.forEach(cls => table.querySelectorAll('.' + cls).forEach(el => el.classList.add('is-hidden')));
    toShow.forEach(cls => table.querySelectorAll('.' + cls).forEach(el => el.classList.remove('is-hidden')));
  }

  function currentSelection(){ return checkboxes.filter(c => c.checked).map(c => c.dataset.col); }

  const initial = currentSelection();
  applyColumns(initial);

  checkboxes.forEach(chk => {
    chk.addEventListener('change', () => applyColumns(currentSelection()));
  });

  document.getElementById('btnMarcarTodos')?.addEventListener('click', () => {
    checkboxes.forEach(c => c.checked = true);
    applyColumns(currentSelection());
  });
  document.getElementById('btnLimpar')?.addEventListener('click', () => {
    checkboxes.forEach(c => c.checked = false);
    applyColumns(currentSelection());
  });

  const doPrint = () => window.print();
  document.getElementById('btnImprimir')?.addEventListener('click', doPrint);
  document.getElementById('btnImprimir2')?.addEventListener('click', doPrint);
  document.getElementById('btnImprimirTopo')?.addEventListener('click', doPrint);

  function exportVisibleTableToCSV(filename){
    const ths = Array.from(table.querySelectorAll('thead th'));
    const visible = ths
      .map((th, idx) => ({ idx, hidden: th.classList.contains('is-hidden'), label: th.textContent.trim() }))
      .filter(x => !x.hidden);

    const rows = [];
    rows.push(['Relatório de Inscritos — {{ evento.nome|escapejs }}']);
    rows.push(visible.map(x => x.label));

    const trs = Array.from(table.querySelectorAll('tbody tr'));
    trs.forEach(tr => {
      const tds = Array.from(tr.children);
      const line = visible.map(x => (tds[x.idx]?.textContent || '').trim());
      rows.push(line);
    });

    const BOM = "\uFEFF";
    const csv = rows.map(line =>
      line.map(v => {
        const needsQuotes = /[",;\n]/.test(v);
        let out = String(v).replace(/"/g,'""');
        return needsQuotes ? `"${out}"` : out;
      }).join(';')
    ).join('\n');

    const blob = new Blob([BOM + csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function suggestedFilename(){
    const today = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `relatorio_inscritos_evento_${eventoId}_${today.getFullYear()}-${pad(today.getMonth()+1)}-${pad(today.getDate())}.csv`;
  }
  const doExcel = () => exportVisibleTableToCSV(suggestedFilename());
  document.getElementById('btnExcel')?.addEventListener('click', doExcel);
  document.getElementById('btnExcel2')?.addEventListener('click', doExcel);
})();
</script>
</body>
</html>
