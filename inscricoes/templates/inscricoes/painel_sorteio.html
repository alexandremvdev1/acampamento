{% load static %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Telão do Sorteio — {{ evento.nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    :root{
      --bg1:#0b1020; --bg2:#111a3a; --ink:#e8eefb; --muted:#99a9c7;
      --tile:#0f172a; --tile-b:#23324d; --accent:#22d3ee; --accent2:#60a5fa; --ok:#10b981;
    }
    html,body{height:100%;margin:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 20% 10%, #0a1130 0%, #0b1020 40%, #070b18 100%),
        linear-gradient(90deg, var(--bg1), var(--bg2));
      overflow:hidden;
    }

    /* Topbar */
    .topbar{
      position:fixed; inset:0 0 auto 0; height:96px;
      display:grid; grid-template-columns: 1fr auto 1fr;
      align-items:center; padding:0 24px;
      background:rgba(0,0,0,.28); backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06); z-index:20;
    }
    .clock{ justify-self:start; color:var(--muted); font-weight:800; letter-spacing:.02em; font-variant-numeric: tabular-nums; }
    .title{ justify-self:center; text-align:center; display:flex; align-items:center; gap:14px; }
    .title h1{ margin:0; font-size:28px; font-weight:900; letter-spacing:.02em; line-height:1.1; }
    .badge-sub{ display:inline-block; margin-top:6px; font-size:14px; font-weight:700; color:var(--muted);
      background:rgba(255,255,255,.08); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12)
    }
    .right-hints{ justify-self:end; display:flex; gap:14px; align-items:center; color:var(--muted); font-size:14px }
    .right-hints kbd{ background:#0b1224; border:1px solid #23324d; padding:2px 6px; border-radius:6px; font-weight:700; color:#cbd5e1; }

    /* Palco */
    .stage{ position:absolute; top:108px; left:0; right:0; bottom:0; padding:24px; display:flex; align-items:center; justify-content:center; }

    /* Cards */
    .card-one, .card-casal{
      position:relative;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0));
      border:1px solid var(--tile-b); border-radius:28px; padding:32px 36px 40px;
      box-shadow:0 22px 70px rgba(0,0,0,.38);
      display:flex; flex-direction:column; align-items:center; text-align:center;
      opacity:0; transform:translateY(18px) scale(.985);
      animation:enter .7s cubic-bezier(.2,.8,.2,1) forwards;
    }
    .card-one{ width:min(1400px, 96vw); }
    .card-casal{
      width:auto;              /* abraça a imagem */
      max-width:96vw;          /* não passa da viewport */
      padding:28px 28px 34px;  /* levemente mais compacto */
    }
    .card-one.fade-out, .card-casal.fade-out{ animation:leave .45s ease forwards; }

    /* Avatar individual */
    .avatar-lg{
      width:380px; height:380px; border-radius:30px;
      border:1px solid var(--tile-b); background:#0b1224; object-fit:cover;
      display:flex; align-items:center; justify-content:center;
      font-weight:900; color:#9cc1ff; font-size:150px; user-select:none;
      box-shadow:0 18px 56px rgba(0,0,0,.35), 0 0 0 7px rgba(34,211,238,.12);
    }

    /* Foto única do casal (hero-wide) – limitada pela viewport */
    .avatar-casal{
      width:auto; height:auto;               /* deixa o browser ajustar */
      max-width:min(92vw, 1280px);           /* largura máxima */
      max-height:min(60vh, 720px);           /* altura máxima */
      border-radius:28px; border:1px solid var(--tile-b);
      object-fit:contain;                    /* não corta a foto */
      background:#0b1224;
      box-shadow:0 18px 56px rgba(0,0,0,.35), 0 0 0 6px rgba(96,165,250,.12);
    }

    /* Fallback: duas fotos lado a lado se não houver foto_casal */
    .pair{ display:flex; align-items:center; justify-content:center; gap:34px; flex-wrap:wrap; }
    .pair .avatar-lg{ width:340px; height:340px; font-size:130px; }

    .info{ margin-top:20px; max-width:92% }
    .nome{ font-size:3.4rem; font-weight:900; line-height:1.06; letter-spacing:.01em; margin:0 0 8px; overflow-wrap:anywhere;
      text-shadow:0 2px 12px rgba(0,0,0,.25); }
    .nome .amp{ opacity:.8; padding:0 .4ch }
    .meta{ font-size:1.45rem; color:var(--muted); font-weight:700 }

    .tag{ position:absolute; right:16px; top:16px; font-size:.95rem; color:#0b1a10; background:#34d399;
      border:1px solid rgba(0,0,0,.15); padding:8px 12px; border-radius:999px; font-weight:900; letter-spacing:.04em;
      box-shadow:0 6px 18px rgba(16,185,129,.35); transform: translateY(-6px); opacity:0; animation:tagIn .5s .15s ease-out forwards; }

    .parabens{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .parabens .chip{ font-size:3.2rem; font-weight:900; letter-spacing:.04em; padding:.22em .75em; border-radius:999px;
      background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#081225; border:1px solid rgba(255,255,255,.35);
      box-shadow:0 24px 70px rgba(96,165,250,.4); transform:translateY(20px) scale(.95); opacity:0; filter:saturate(1.4);
      animation:congrats .95s ease-out forwards; }

    .placeholder{ color:var(--muted); text-align:center; opacity:.9; font-weight:700; font-size:1.3rem; }

    .confetti{ position:fixed; width:10px; height:14px; top:-10px; opacity:.95; z-index:30 }
    @keyframes fall{ 0%{transform:translateY(-10px) rotate(0)} 100%{transform:translateY(110vh) rotate(360deg)} }
    @keyframes enter{ to{opacity:1; transform:translateY(0) scale(1)} }
    @keyframes leave{ to{opacity:0; transform:translateY(10px) scale(.98)} }
    @keyframes tagIn{ from{transform:translateY(-6px);opacity:0} to{transform:translateY(0);opacity:1} }
    @keyframes congrats{
      0%{opacity:0;transform:translateY(20px) scale(.95)}
      35%{opacity:1;transform:translateY(0) scale(1)}
      80%{opacity:1;transform:translateY(-2px) scale(1.02)}
      100%{opacity:0;transform:translateY(-8px) scale(.98)}
    }

    @media (max-width: 1200px){
      .avatar-casal{ max-height:52vh; }
    }
    @media (min-width: 1600px){
      .avatar-lg{ width:420px; height:420px; font-size:170px }
      .nome{ font-size:3.7rem } .meta{ font-size:1.55rem } .parabens .chip{ font-size:3.4rem }
    }
    @media (min-width: 1800px){
      .avatar-casal{ max-width:1400px; max-height:58vh; }
    }
    body.is-fs .topbar{ background:rgba(0,0,0,.22); }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="clock" id="clock">—</div>
    <div class="title">
      <div>
        <h1>SORTEIO — {{ evento.nome }}</h1>
        <span class="badge-sub">{{ evento.get_tipo_display }}</span>
      </div>
    </div>
    <div class="right-hints">
      <span>Atalhos: <kbd>F</kbd> tela cheia • <kbd>⭑</kbd> duplo-clique</span>
    </div>
  </div>

  <div class="stage">
    <div id="holder" class="placeholder">Aguardando o primeiro sorteado…</div>
  </div>

  <script>
    /* ===== relógio ===== */
    (function startClock() {
      const el = document.getElementById('clock');
      if (!el) return;
      const initISO = "{{ server_now_iso|default:'' }}";
      let now = initISO ? new Date(initISO) : new Date();
      const fmt = (d)=> d.toLocaleString('pt-BR', {
        weekday:'short', year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      }).replace(',', ' •');
      function tick(){ el.textContent = fmt(now); now = new Date(now.getTime() + 1000); }
      tick(); setInterval(tick, 1000);
    })();

    /* ===== fullscreen ===== */
    function toggleFullscreen(el = document.documentElement) {
      const d = document, isFS = d.fullscreenElement || d.webkitFullscreenElement || d.msFullscreenElement;
      if (!isFS) (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen)?.call(el);
      else (d.exitFullscreen||d.webkitExitFullscreen||d.msExitFullscreen)?.call(d);
    }
    document.addEventListener('keydown', (ev)=>{ if (ev.key.toLowerCase() === 'f'){ ev.preventDefault(); toggleFullscreen(); }});
    document.addEventListener('dblclick', ()=> toggleFullscreen());
    ['fullscreenchange','webkitfullscreenchange','msfullscreenchange'].forEach(evt=>{
      document.addEventListener(evt, ()=> document.body.classList.toggle('is-fs', !!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement)));
    });

    /* ===== utilitários de avatar ===== */
    function letterAvatar(nome){
      const el = document.createElement('div');
      el.className = 'avatar-lg';
      el.textContent = (nome||'').trim().charAt(0).toUpperCase() || '?';
      return el;
    }
    function imgAvatar(url, extraClass){
      const img = document.createElement('img');
      img.className = extraClass || 'avatar-lg';
      img.src = url; img.alt = 'Foto'; img.loading = 'eager';
      img.decoding = 'async'; img.referrerPolicy = 'no-referrer';
      return img;
    }

    /* ===== foto do CASAL (prioridade) =====
       1) item.foto_casal (API já agregou)
       2) p1.foto_casal / p1.casal_foto
       3) p2.foto_casal / p2.casal_foto
    */
    function getCasalFoto(root, a, b){
      if (root && root.foto_casal) return root.foto_casal;
      const tryKeys = ['foto_casal','casal_foto'];
      for (const k of tryKeys){ if (a && a[k]) return a[k]; }
      for (const k of tryKeys){ if (b && b[k]) return b[k]; }
      return null;
    }

    /* ===== construção dos cards ===== */
    function makeSingleCard(p){
      const card = document.createElement('div'); card.className = 'card-one';
      const avatar = p.foto ? imgAvatar(p.foto) : letterAvatar(p.nome);
      const info = document.createElement('div'); info.className = 'info';
      const nome = document.createElement('div'); nome.className = 'nome'; nome.textContent = p.nome;
      const meta = document.createElement('div'); meta.className = 'meta';
      meta.textContent = [p.cidade, p.estado].filter(Boolean).join(' • ');
      const tag = document.createElement('div'); tag.className = 'tag'; tag.textContent = 'PARABÉNS!';
      const overlay = document.createElement('div'); overlay.className = 'parabens';
      const chip = document.createElement('div'); chip.className = 'chip'; chip.textContent = '🎉 PARABÉNS 🎉';
      overlay.appendChild(chip);
      card.append(avatar, info, tag, overlay);
      info.append(nome, meta);
      return card;
    }

    function makeCasalCard(root, a, b){
      const card = document.createElement('div'); card.className = 'card-casal';
      const casalFoto = getCasalFoto(root, a, b);

      if (casalFoto){
        const hero = imgAvatar(casalFoto, 'avatar-casal');   /* foto única do casal */
        card.appendChild(hero);
      } else {
        const pair = document.createElement('div'); pair.className = 'pair'; /* fallback: 2 fotos */
        pair.appendChild(a.foto ? imgAvatar(a.foto) : letterAvatar(a.nome));
        pair.appendChild(b.foto ? imgAvatar(b.foto) : letterAvatar(b.nome));
        card.appendChild(pair);
      }

      const info = document.createElement('div'); info.className = 'info';
      const nome = document.createElement('div'); nome.className = 'nome';
      const spanA = document.createElement('span'); spanA.textContent = a.nome;
      const amp = document.createElement('span'); amp.className = 'amp'; amp.textContent = ' & ';
      const spanB = document.createElement('span'); spanB.textContent = b.nome;
      nome.append(spanA, amp, spanB);

      const locA = [a.cidade, a.estado].filter(Boolean).join(' - ');
      const locB = [b.cidade, b.estado].filter(Boolean).join(' - ');
      const meta = document.createElement('div'); meta.className = 'meta';
      meta.textContent = (locA && locB) ? (locA === locB ? locA : `${locA} • ${locB}`) : (locA || locB);

      const tag = document.createElement('div'); tag.className = 'tag'; tag.textContent = 'CASAL SORTEADO';
      const overlay = document.createElement('div'); overlay.className = 'parabens';
      const chip = document.createElement('div'); chip.className = 'chip'; chip.textContent = '🎉 PARABÉNS AO CASAL 🎉';
      overlay.appendChild(chip);

      card.append(info, tag, overlay);
      info.append(nome, meta);
      return card;
    }

    /* ===== confetes + troca de card ===== */
    function burstConfetti(){
      const colors = ['#22d3ee','#60a5fa','#f472b6','#34d399','#fbbf24','#ef4444'];
      for (let i = 0; i < 100; i++){
        const c = document.createElement('div');
        c.className = 'confetti';
        c.style.left = (Math.random()*100)+'vw';
        c.style.background = colors[Math.floor(Math.random()*colors.length)];
        c.style.transform = `rotate(${Math.random()*360}deg)`;
        c.style.animation = `fall ${2.2 + Math.random()*1.6}s linear forwards`;
        c.style.opacity = 0.85 + Math.random()*0.15;
        c.style.width = (8 + Math.random()*8) + 'px';
        c.style.height = (10 + Math.random()*12) + 'px';
        document.body.appendChild(c);
        setTimeout(()=> c.remove(), 4200);
      }
    }
    function swapCard(newCard){
      const stage = document.querySelector('.stage');
      const old = stage.querySelector('.card-one, .card-casal');
      if(!old){
        document.getElementById('holder')?.remove();
        stage.appendChild(newCard); burstConfetti(); return;
      }
      old.classList.add('fade-out');
      old.addEventListener('animationend', () => { old.remove(); stage.appendChild(newCard); burstConfetti(); }, {once:true});
    }

    /* ===== normalização da resposta ===== */
    const API_URL = "{% url 'inscricoes:api_selecionados' slug=evento.slug %}";
    const IS_CASAIS = {% if evento.tipo == 'casais' %}true{% else %}false{% endif %};
    let pollMs = 2000, currentKey = null;

    function normalizeItem(it){
      if (IS_CASAIS) {
        if (it && it.casal && it.p1 && it.p2){ return { mode:'casal', key:`casal:${it.p1.id}+${it.p2.id}`, root:it, p1:it.p1, p2:it.p2 }; }
        if (it && Array.isArray(it.dupla) && it.dupla.length === 2){ const [p1,p2]=it.dupla; return { mode:'casal', key:`casal:${p1.id}+${p2.id}`, root:it, p1, p2 }; }
        if (it && it.par && it.par.id){ return { mode:'casal', key:`casal:${it.id}+${it.par.id}`, root:it, p1:it, p2:it.par }; }
      }
      return { mode:'single', key:`single:${it?.id}`, root:it, p1:it };
    }

    async function tick(){
      try{
        const r = await fetch(API_URL, {cache:'no-store'}); if(!r.ok) throw new Error('fetch fail');
        const data = await r.json();
        const lista = Array.isArray(data.selecionados) ? data.selecionados : [];
        if (!lista.length) return;
        const raw = lista[lista.length - 1];
        const norm = normalizeItem(raw);
        if (!norm.p1) return;

        if (norm.key !== currentKey){
          currentKey = norm.key;
          const card = norm.mode === 'casal'
            ? makeCasalCard(norm.root, norm.p1, norm.p2)
            : makeSingleCard(norm.p1);
          swapCard(card);
        }
      }catch(e){ console.debug('tick error', e); }
      finally{ setTimeout(tick, pollMs); }
    }
    tick();
  </script>
</body>
</html>
