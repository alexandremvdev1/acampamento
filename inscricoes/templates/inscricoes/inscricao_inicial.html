<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Inscri√ß√£o - {{ evento.nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --space-1:6px; --space-2:10px; --space-3:14px; --space-4:18px; --space-5:22px;
    }
    *{box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Open Sans","Helvetica Neue",sans-serif;
      line-height:1.5;
      max-width:480px;
      margin:20px auto;
      padding:15px;
      background:#fff;
      color:#333;
      position:relative;
    }
    body::before{
      content:"";position:fixed;inset:0;
      background-image:url("{{ politica.imagem_2.url }}");
      background-size:cover;background-position:center;
      filter:blur(5px);opacity:.2;z-index:-1;
    }
    header{text-align:center;margin-bottom:var(--space-5);position:relative}
    header img{display:block;max-width:100%;height:auto;border-radius:8px;margin:0 auto var(--space-3);box-shadow:0 4px 6px rgba(0,0,0,.1)}
    header h1{font-size:1.8rem;margin:0 0 var(--space-1);color:#222}
    .info-periodos p{font-size:.95rem;margin:2px 0;color:#555;line-height:1.35}
    #id_endereco, #id_bairro { text-transform: capitalize; }
    #id_nome { text-transform: capitalize; }

    form{
      background:#fff;padding:20px 18px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.1);
      display:flex;flex-direction:column;gap:var(--space-3);position:relative
    }
    .field{display:flex;flex-direction:column;row-gap:6px}
    .field label{font-weight:600;color:#444}
    .field input[type="text"], .field input[type="email"]{
      padding:10px 12px;font-size:1rem;border:1.8px solid #ccc;border-radius:12px;
      transition:border-color .25s ease, box-shadow .25s ease;width:100%;background:#fff;
    }
    .field input:focus{border-color:#007bff;outline:none;box-shadow:0 0 0 3px rgba(0,123,255,.15)}
    .errorlist{margin:0;padding-left:18px;color:#b00020;font-size:.9rem}
    .hint{font-size:.85rem;color:#666;margin-top:-4px}
    #id_cpf[aria-invalid="true"]{border-color:#b00020}
    .cpf-error{font-size:.9rem;color:#b00020;margin:-4px 0 0}

    .extra-fields{display:grid;grid-template-columns:1fr;gap:var(--space-3);margin-top:var(--space-2)}
    .extra-fields[hidden]{display:none!important}

    button{
      background:#007bff;color:#fff;padding:12px;border:none;border-radius:10px;
      font-size:1.05rem;font-weight:700;cursor:pointer;transition:background-color .25s ease;margin-top:2px;
    }
    button:hover,button:focus{background:#0056b3;outline:none}
    button[disabled]{opacity:.6;cursor:not-allowed}

    .politica-link{text-align:center;margin-top:var(--space-4);font-weight:600}
    .politica-link a{color:#007bff;text-decoration:none}
    .politica-link a:hover{text-decoration:underline}

    #whatsapp-flutuante{position:fixed;bottom:20px;right:20px;background:#009443;width:60px;height:60px;border-radius:50%;
      box-shadow:0 4px 8px rgba(0,0,0,.3);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1100;
      transition:background-color .25s ease;font-size:30px;color:#fff;user-select:none}
    #whatsapp-flutuante:hover{background:#02853d}

    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;
      overflow:auto;background-color:rgba(0,0,0,.5);justify-content:center;align-items:center;padding:20px}
    .modal-content{background:#fff;border-radius:10px;max-width:400px;width:100%;box-shadow:0 5px 15px rgba(0,0,0,.3);
      position:relative;font-size:.95rem;color:#222;max-height:70vh;overflow-y:auto;padding:20px;text-align:center}
    .modal-body{text-align:left}
    .close-modal{color:#aaa;position:absolute;right:15px;top:10px;font-size:28px;font-weight:bold;cursor:pointer}
    .close-modal:hover,.close-modal:focus{color:#000}

    @media (max-width:480px){
      body{margin:10px;padding:10px;padding-bottom:90px}
      form{padding:16px;border-radius:12px}
    }
  </style>
</head>
<body>
  <header>
    {% if evento.banner %}
      <img src="{{ evento.banner.url }}" alt="Banner do Evento {{ evento.nome }}">
    {% endif %}
    <h1>{{ evento.nome }}</h1>
    <div class="info-periodos">
      <p><strong>Per√≠odo de Inscri√ß√£o:</strong> {{ evento.inicio_inscricoes|date:"d/m/Y" }} ‚Äì {{ evento.fim_inscricoes|date:"d/m/Y" }}</p>
      <p><strong>Per√≠odo do Evento:</strong> {{ evento.data_inicio|date:"d/m/Y" }} ‚Äì {{ evento.data_fim|date:"d/m/Y" }}</p>
    </div>
  </header>

  {% if form %}
  <!-- ETAPA 1: CPF ‚Üí revela demais campos quando v√°lido -->
  <form method="post" novalidate id="form-inscricao">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="field">
      <label for="id_cpf">CPF</label>
      {{ form.cpf.errors }}
      {{ form.cpf }}
      <small class="hint">Digite seu CPF (11 d√≠gitos). Ex.: 123.456.789-09</small>
      <div id="cpf_error" class="cpf-error" aria-live="polite"></div>
    </div>

    <div id="extra-fields" class="extra-fields" hidden aria-hidden="true">
      <div class="field">
        <label for="id_nome">Nome</label>
        {{ form.nome.errors }}
        {{ form.nome }}
      </div>

      <div class="field">
        <label for="id_telefone">Telefone</label>
        {{ form.telefone.errors }}
        {{ form.telefone }}
      </div>

      <div class="field">
        <label for="id_email">Email</label>
        {{ form.email.errors }}
        {{ form.email }}
        <small class="hint">Por aqui voc√™ receber√° informa√ß√µes sobre o evento.</small>
      </div>
    </div>

    <button type="submit" id="btn-next" disabled>Pr√≥xima Etapa</button>
  </form>
  {% endif %}

  {% if endereco_form %}
  <!-- ETAPA 2: Endere√ßo -->
  <form method="post" novalidate style="margin-top: var(--space-5);">
    {% csrf_token %}
    {{ endereco_form.non_field_errors }}

    <div class="field">
      <label for="id_CEP">CEP</label>
      {{ endereco_form.CEP.errors }}
      {{ endereco_form.CEP }}
    </div>
    <div class="field">
      <label for="id_endereco">Endere√ßo</label>
      {{ endereco_form.endereco.errors }}
      {{ endereco_form.endereco }}
    </div>
    <div class="field">
      <label for="id_numero">N√∫mero</label>
      {{ endereco_form.numero.errors }}
      {{ endereco_form.numero }}
    </div>
    <div class="field">
      <label for="id_bairro">Bairro</label>
      {{ endereco_form.bairro.errors }}
      {{ endereco_form.bairro }}
    </div>
    <div class="field">
      <label for="id_cidade">Cidade</label>
      {{ endereco_form.cidade.errors }}
      {{ endereco_form.cidade }}
    </div>
    <div class="field">
      <label for="id_estado">Estado</label>
      {{ endereco_form.estado.errors }}
      {{ endereco_form.estado }}
    </div>

    <button type="submit">Pr√≥xima Etapa</button>
  </form>
  {% endif %}

  <p class="politica-link">
    <a href="#" data-bs-toggle="modal" data-bs-target="#modalPolitica">Pol√≠tica de Privacidade</a>
  </p>
  <p style="text-align:center;font-size:.75rem;color:rgba(0,0,0,.25);margin-top:4px;">
    Desenvolvido por Alexandre Martins Vieira
  </p>

  <!-- Modal da Pol√≠tica -->
  <div class="modal fade" id="modalPolitica" tabindex="-1" aria-labelledby="modalPoliticaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalPoliticaLabel">Pol√≠tica de Privacidade</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">{{ politica.texto|linebreaks }}</div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div>
      </div>
    </div>
  </div>

  <!-- WhatsApp flutuante -->
  <div id="whatsapp-flutuante" title="Fale conosco pelo WhatsApp">‚Äãüôãüèº‚Äç‚ôÇÔ∏è‚Äã</div>
  <div id="modal-whatsapp" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modal-whatsapp-title">
    <div class="modal-content">
      <span class="close-modal" id="fechar-whatsapp" aria-label="Fechar">&times;</span>
      <h2 id="modal-whatsapp-title">Fale conosco pelo WhatsApp</h2>
      <p>Estamos prontos para ajudar voc√™!</p>
      <a href="https://wa.me/5511999999999" target="_blank" rel="noopener noreferrer" class="btn-whatsapp">Abrir WhatsApp</a>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Inputmask -->
  <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.9/dist/inputmask.min.js"></script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Base da URL para ver_inscricao (gera /inscricao/0/ e depois remove o 0)
    const verInscricaoBase = "{% url 'inscricoes:ver_inscricao' 0 %}".replace('/0/', '/');

    const form1         = document.getElementById("form-inscricao");
    const cpfInput      = document.getElementById("id_cpf");
    const nomeInput     = document.getElementById("id_nome");
    const emailInput    = document.getElementById("id_email");
    const telefoneInput = document.getElementById("id_telefone");
    const cepInput      = document.getElementById("id_CEP");
    const enderecoInput = document.getElementById("id_endereco");
    const bairroInput   = document.getElementById("id_bairro");
    const cidadeInput   = document.getElementById("id_cidade");
    const estadoInput   = document.getElementById("id_estado");
    const btnNext       = document.getElementById("btn-next");
    const cpfErrBox     = document.getElementById("cpf_error");
    const extraBox      = document.getElementById("extra-fields");

    // M√°scaras
    try{ if(cpfInput){ Inputmask("999.999.999-99").mask(cpfInput); cpfInput.placeholder='000.000.000-00'; } }catch(e){}
    try{ if(telefoneInput){ Inputmask({mask:["(99) 9999-9999","(99) 99999-9999"], keepStatic:true}).mask(telefoneInput); } }catch(e){}
    try{ if(cepInput){ Inputmask("99.999-999").mask(cepInput); } }catch(e){}

    // utils
    const onlyDigits = s => (s||"").replace(/\D/g,"");
    function cpfIsValid(raw){
      const c = onlyDigits(raw);
      if(c.length!==11) return false;
      if(/^(\d)\1{10}$/.test(c)) return false;
      let sum=0; for(let i=0;i<9;i++) sum += parseInt(c[i],10)*(10-i);
      let d1=11-(sum%11); if(d1>9) d1=0; if(d1!==parseInt(c[9],10)) return false;
      sum=0; for(let i=0;i<10;i++) sum += parseInt(c[i],10)*(11-i);
      let d2=11-(sum%11); if(d2>9) d2=0; return d2===parseInt(c[10],10);
    }
    function toggleExtraFields(show){
      if(!extraBox) return;
      if(show){ extraBox.hidden=false; extraBox.setAttribute('aria-hidden','false'); }
      else{ extraBox.hidden=true; extraBox.setAttribute('aria-hidden','true'); }
    }
    function applyCpfValidation(){
      if(!cpfInput) return false;
      const raw=cpfInput.value||"";
      const digits=onlyDigits(raw);
      const valid=(digits.length===11 && cpfIsValid(digits));
      cpfInput.setAttribute("aria-invalid", (!valid && digits.length>0) ? "true" : "false");
      cpfErrBox.textContent = (!valid && digits.length>0) ? "CPF inv√°lido. Verifique os d√≠gitos." : "";
      btnNext && (btnNext.disabled = !valid || extraBox.hidden);
      return valid;
    }

    // Capitaliza primeira letra do primeiro nome ENQUANTO DIGITA
    function liveCapitalizeFirstName(e){
      const el = e.target;
      let v = (el.value||"");
      if(!v) return;
      // quebra em blocos por espa√ßo, capitaliza s√≥ o primeiro
      const parts = v.split(/\s+/);
      if(parts.length){
        parts[0] = parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase();
        // mantemos o restante como foi digitado
        const novo = parts.join(' ');
        if(novo !== v){
          const pos = el.selectionStart;
          el.value = novo;
          try{ el.setSelectionRange(pos,pos); }catch(_){}
        }
      }
    }
    if(nomeInput){
      nomeInput.addEventListener('input', liveCapitalizeFirstName);
      nomeInput.addEventListener('blur',  liveCapitalizeFirstName);
    }

    // CPF input/paste ‚Üí mostra/oculta extras
    if(cpfInput){
      const onCpfChange = () => {
        const ok = applyCpfValidation();
        toggleExtraFields(ok);
        if(ok && nomeInput && !nomeInput.value){ nomeInput.focus(); }
      };
      cpfInput.addEventListener("input", onCpfChange);
      cpfInput.addEventListener("paste", () => setTimeout(onCpfChange, 0));
    }

    // CPF blur ‚Üí AJAX para retomar etapa se j√° existir inscri√ß√£o
    if(cpfInput){
      cpfInput.addEventListener("blur", async () => {
        if(!applyCpfValidation()) return;
        const cpf = onlyDigits(cpfInput.value);
        if(cpf.length!==11) return;
        try{
          const url = `/ajax/buscar-participante/?cpf=${cpf}&evento_id={{ evento.id }}`;
          const res = await fetch(url);
          if(!res.ok) return;
          const data = await res.json();

          // 1) Se houver pr√≥xima etapa ‚Üí redireciona para ela
          if (data.progresso && data.progresso.next_url) {
            window.location.href = data.progresso.next_url;
            return;
          }

          // 2) J√° enviada/conclu√≠da ‚Üí resumo
          if (data.status === 'enviada' || data.status === 'concluida') {
            const destino = data.view_url || (verInscricaoBase + (data.inscricao_id || '') + '/');
            window.location.href = destino;
            return;
          }

          // 3) Sem inscri√ß√£o para este evento ‚Üí autopreenche (segue fluxo)
          if (data.existe_participante && data.status === 'sem_inscricao') {
            if (data.nome && nomeInput)       nomeInput.value = data.nome;
            if (data.email && emailInput)     emailInput.value = data.email;
            if (data.telefone && telefoneInput) telefoneInput.value = data.telefone;
          }
        }catch(err){
          console.error("Erro ao buscar participante:", err);
        }
      });
    }

    // Submit guard
    if(form1){
      form1.addEventListener("submit",(e)=>{
        const ok = applyCpfValidation();
        if(!ok || extraBox.hidden){
          e.preventDefault();
          cpfInput?.focus();
        }
      });
    }

    // ViaCEP (quando estamos no form de endere√ßo)
    const limpaEndereco=()=>{
      enderecoInput && (enderecoInput.value="");
      bairroInput && (bairroInput.value="");
      cidadeInput && (cidadeInput.value="");
      estadoInput && (estadoInput.value="");
    }
    if(cepInput){
      cepInput.addEventListener("blur", async () => {
        const cep = onlyDigits(cepInput.value);
        if(!/^[0-9]{8}$/.test(cep)){
          limpaEndereco();
          if(cep) alert("Formato de CEP inv√°lido.");
          return;
        }
        [enderecoInput,bairroInput,cidadeInput,estadoInput].forEach(i=>i&&(i.value="..."));
        try{
          const resCep = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          const d = await resCep.json();
          if(d.erro) throw new Error("CEP n√£o encontrado.");
          enderecoInput && (enderecoInput.value = d.logradouro || "");
          bairroInput   && (bairroInput.value   = d.bairro || "");
          cidadeInput   && (cidadeInput.value   = d.localidade || "");
          estadoInput   && (estadoInput.value   = d.uf || "");
        }catch(e){
          console.error("Erro ao buscar CEP:", e);
          alert(e.message || "Erro ao buscar CEP.");
          limpaEndereco();
        }
      });
    }

    // Modal WhatsApp
    const modal = document.getElementById("modal-whatsapp");
    const btn   = document.getElementById("whatsapp-flutuante");
    const close = document.getElementById("fechar-whatsapp");
    btn?.addEventListener("click", ()=> modal.style.display="flex");
    close?.addEventListener("click", ()=> modal.style.display="none");
    window.addEventListener("click", e => e.target===modal && (modal.style.display="none"));
    window.addEventListener("keydown", e => e.key==="Escape" && (modal.style.display="none"));

    // Estado inicial do form 1
    if(cpfInput){
      const startValid = applyCpfValidation();
      toggleExtraFields(startValid);
      if(startValid && btnNext) btnNext.disabled = false;
    }
  });
  </script>
</body>
</html>
