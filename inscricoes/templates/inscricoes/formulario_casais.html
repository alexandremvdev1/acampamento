{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Inscrição Casal - {{ evento.nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Datepicker + FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, sans-serif;
      max-width: 900px; margin: 20px auto; padding: 15px; background-color: #fff; color: #333; position: relative;
    }
    {% if politica and politica.imagem_2 %}
    body::before {
      content: ""; position: fixed; inset: 0;
      background-image: url("{{ politica.imagem_2.url }}"); background-size: cover; background-position: center;
      filter: blur(5px); opacity: 0.2; z-index: -1;
    }
    {% endif %}

    header { text-align: center; margin-bottom: 20px; }
    header img { max-width: 100%; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    header h1 { font-size: 1.6rem; margin-bottom: 6px; color: #222; }

    :root{
      --radius: .7rem;
      --inp-pad-y: .45rem;
      --inp-pad-x: .6rem;
      --inp-fs: .95rem;
    }
    form { background: white; padding: 18px 16px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.08); display: flex; flex-direction: column; gap: 14px; }
    fieldset { border: 1px solid #e5e7eb; padding: 16px; border-radius: 12px; margin-bottom: 18px; }
    legend { font-size: 1.05rem; font-weight: 800; color: #0d6efd; padding: 0 .4rem; }

    label { font-weight: 600; margin-top: 8px; display: block; font-size: .92rem; }

    input[type="text"], input[type="email"], input[type="number"], input[type="date"], select, textarea {
      padding: var(--inp-pad-y) var(--inp-pad-x);
      font-size: var(--inp-fs);
      border: 1.6px solid #d1d5db;
      border-radius: var(--radius);
      transition: border-color .15s ease, box-shadow .15s ease;
      width: 100%;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #93c5fd;
      outline: none;
      box-shadow: 0 0 0 .2rem rgba(59,130,246,.15);
    }

    .form-control, .form-select {
      padding: var(--inp-pad-y) var(--inp-pad-x);
      font-size: var(--inp-fs);
      border-radius: var(--radius);
    }

    .input-group-sm > .form-control, .input-group-sm > .form-select, .input-group-sm > .input-group-text {
      padding: var(--inp-pad-y) var(--inp-pad-x);
      font-size: var(--inp-fs);
      border-radius: var(--radius);
    }
    .input-group-text{ background:#f8fafc; border:1.6px solid #d1d5db; }

    button {
      background: #0d6efd; color: white;
      padding: .7rem 1rem; border: none; border-radius: .9rem;
      font-size: 1rem; font-weight: 800; cursor: pointer; transition: background-color .2s ease, transform .05s ease;
    }
    button:hover { background:#0b5ed7; }
    button:active { transform: translateY(1px); }

    .helptext, .text-danger { font-size: .83rem; }
    .campo-filho { margin-top: 12px; padding: 10px; border: 1px dashed #d1d5db; border-radius: .9rem; background:#fafafa; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); justify-content: center; align-items: center; z-index: 2000; }
    .modal.show { display: flex; }
    .modal-content { background: #fff; border-radius: 12px; padding: 18px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; text-align: center; position: relative; }
    .close { position: absolute; right: 14px; top: 8px; font-size: 26px; cursor: pointer; }

    #whatsapp-flutuante {
      position: fixed; bottom: 20px; right: 20px;
      width: 58px; height: 58px; border-radius: 50%; cursor: pointer;
      display: flex; align-items: center; justify-content: center; z-index: 2100;
      transition: transform .15s ease, box-shadow .15s ease; box-shadow: 0 4px 10px rgba(0,0,0,.25);
      overflow: hidden;
    }
    #whatsapp-flutuante img { width: 100%; height: 100%; object-fit: cover; }
    #whatsapp-flutuante:hover { transform: scale(1.06); box-shadow: 0 6px 16px rgba(0,0,0,.35); }

    .btn-whatsapp { background-color: #25D366; color: white; border: none; border-radius: .9rem; padding: .7rem 1rem; font-size: 1rem; font-weight: 700; text-decoration: none; display: inline-block; transition: background-color .2s ease; }
    .btn-whatsapp:hover { background-color: #128C4A; }

    .politica-link { text-align: center; margin-top: 14px; font-weight: 600; }
    .politica-link a { color: #0d6efd; text-decoration: none; }
    .politica-link a:hover { text-decoration: underline; }

    footer { text-align: center; font-size: 0.75rem; color: rgba(0,0,0,0.35); margin-top: 8px; }

    #preview-foto-casal{
      width: 90px; height: 90px; object-fit: cover; border-radius: 12px;
      border: 1px solid #e5e7eb; background: #f8fafc; display: none;
    }

    .input-group-text i{ opacity:.8; }

    .init-cap { text-transform: capitalize; }
  </style>
</head>
<body>
  <header>
    {% if evento.banner %}
      <img src="{{ evento.banner.url }}" alt="Banner {{ evento.nome }}">
    {% endif %}
    <h1>{{ evento.nome }}</h1>
    <p><strong>Data:</strong> {{ evento.data_inicio|date:"d/m/Y" }} - {{ evento.data_fim|date:"d/m/Y" }}</p>
  </header>

  <!-- data-etapa para o script saber se é cônjuge 1 ou 2 -->
  <form method="post" enctype="multipart/form-data" novalidate data-etapa="{{ etapa }}">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}
    {% if form_insc.non_field_errors %}
      <div class="alert alert-danger">{{ form_insc.non_field_errors }}</div>
    {% endif %}

    <fieldset>
      <legend>Cônjuge {{ etapa }}</legend>

      <!-- Nome + CPF + Data de nascimento -->
      <div class="row g-3">
        <div class="col-md-4">
          <label for="{{ form.nome.id_for_label }}">Nome completo</label>
          {{ form.nome }} <div class="text-danger">{{ form.nome.errors }}</div>
        </div>
        <div class="col-md-4">
          <label for="{{ form.cpf.id_for_label }}">CPF</label>
          {{ form.cpf }} <div class="text-danger">{{ form.cpf.errors }}</div>
        </div>
        <div class="col-md-4">
          {% if form.data_nascimento %}
            <label for="{{ form.data_nascimento.id_for_label }}">Data de nascimento</label>
            {{ form.data_nascimento }} <div class="text-danger">{{ form.data_nascimento.errors }}</div>
          {% endif %}
        </div>
      </div>

      <!-- E-mail + Telefone + Tema do acampamento -->
      <div class="row g-3 align-items-end" id="linha-identidade-2">
        <div class="col-md-6">
          <label for="{{ form.email.id_for_label }}">E-mail</label>
          {{ form.email }} <div class="text-danger">{{ form.email.errors }}</div>
        </div>
        <div class="col-md-6">
          <label for="{{ form.telefone.id_for_label }}">Telefone</label>
          {{ form.telefone }} <div class="text-danger">{{ form.telefone.errors }}</div>
        </div>

        <div class="col-md-6" id="slot-tema-acampamento">
          <label for="id_tema_acampamento">Qual tema do acampamento que participou?</label>
          <input
            type="text"
            id="id_tema_acampamento"
            name="tema_acampamento"
            class="form-control init-cap"
            placeholder="Ex.: Acampamento de Jovens 2023"
            value="{{ request.POST.tema_acampamento|default_if_none:'' }}"
          >
        </div>
      </div>

      {% if etapa == 1 %}
      <!-- ====================== ENDEREÇO (CÔNJUGE 1) ====================== -->
      <fieldset id="fieldset-endereco" class="mt-1">
        <legend>Endereço</legend>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label" for="id_cep">CEP</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text"><i class="fa-solid fa-mailbox"></i></span>
              <input type="text" id="id_cep" name="cep" class="form-control" placeholder="00000-000" required>
            </div>
          </div>
          <div class="col-md-8">
            <label class="form-label" for="id_endereco">Logradouro</label>
            <input type="text" id="id_endereco" name="endereco" class="form-control init-cap" placeholder="Rua, Av., Travessa..." required>
          </div>
          <div class="col-md-4">
            <label class="form-label" for="id_numero">Número</label>
            <input type="text" id="id_numero" name="numero" class="form-control" placeholder="Nº" required>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="id_bairro">Bairro</label>
            <input type="text" id="id_bairro" name="bairro" class="form-control init-cap" required>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="id_cidade">Cidade</label>
            <input type="text" id="id_cidade" name="cidade" class="form-control init-cap" required>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="id_estado">Estado (UF)</label>
            <input type="text" id="id_estado" name="estado" class="form-control" maxlength="2" placeholder="SP" required>
          </div>
        </div>
        <div class="alert alert-info mt-3" role="alert">
          Esse endereço será utilizado para o cônjuge 2 automaticamente.
        </div>
      </fieldset>
      {% endif %}

      {% if etapa == 1 %}
      <div class="mb-2">
        <label for="id_qtd_filhos">Quantidade de filhos</label>
        <select id="id_qtd_filhos" name="qtd_filhos" class="form-select">
          <option value="0">Nenhum</option>
          <option value="1">1 filho</option>
          <option value="2">2 filhos</option>
          <option value="3">3 filhos</option>
          <option value="4">4 filhos</option>
        </select>
      </div>
      <div id="filhos_campos"></div>

      <!-- Compartilhados (view espera esses names) -->
      <fieldset class="mt-3">
        <legend>Contato de emergência</legend>
        <label>Nome</label>
        <input type="text" name="contato_emergencia_nome" class="form-control init-cap">
        <label>Telefone</label>
        <input type="text" name="contato_emergencia_telefone" class="form-control">
      </fieldset>

      <fieldset class="mt-3">
        <legend>Contato adicional</legend>
        <label>Nome</label>
        <input type="text" name="responsavel_2_nome" class="form-control init-cap">
        <label>Telefone</label>
        <input type="text" name="responsavel_2_telefone" class="form-control">
      </fieldset>
      {% endif %}

      {# ===== Demais campos do form de casais (exclui foto_casal, tema_acampamento e "Outra pastoral ou movimento") ===== #}
      {% for field in form_insc %}
        {% if field.name != "foto_casal" and field.name != "tema_acampamento" and field.name != "outra_pastoral_ou_movimento" and field.name != "outra_pastoral" and field.name != "outro_movimento" and field.name != "pastoral_movimento_outro" %}
          <div class="mb-2 form-insc-field" data-field-name="{{ field.name }}">
            {{ field.label_tag }}
            {{ field }}
            {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
            {% for err in field.errors %}<div class="text-danger">{{ err }}</div>{% endfor %}
          </div>
        {% endif %}
      {% endfor %}

      {% if etapa == 2 %}
      <!-- ============== FOTO DO CASAL — SOMENTE NA ETAPA 2 ============== -->
      <div id="foto-casal-final" class="mb-3">
        <label for="{{ form_insc.foto_casal.id_for_label }}">Foto do casal</label>
        <div class="d-flex align-items-center gap-3">
          <img id="preview-foto-casal" alt="Pré-visualização">
          {{ form_insc.foto_casal }}
        </div>
        <div class="form-text">A foto será salva nas duas inscrições e nos dois participantes.</div>
        <div class="text-danger">{{ form_insc.foto_casal.errors }}</div>
      </div>
      {% endif %}

    </fieldset>

    <button type="submit">
      {% if etapa == 1 %}Continuar (Cônjuge 2){% else %}Finalizar inscrição{% endif %}
    </button>
  </form>

  <p class="politica-link">
    <a href="#" onclick="openModal('modalPolitica')">Política de Privacidade</a>
  </p>

  <footer>eismeaqui.app - Desenvolvido por Alexandre Martins Vieira 2025 ©</footer>

  <div id="modalPolitica" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('modalPolitica')">&times;</span>
      <h3>Política de Privacidade</h3>
      {% if politica %}{{ politica.texto|linebreaks }}{% endif %}
    </div>
  </div>

  <div id="whatsapp-flutuante" onclick="openModal('modalWhatsApp')">
    {% if politica and politica.imagem_ajuda %}
      <img src="{{ politica.imagem_ajuda.url }}" alt="Ajuda">
    {% else %}
      <img src="{% static 'img/ajuda/porquinho.png' %}" alt="Ajuda">
    {% endif %}
  </div>

  <div id="modalWhatsApp" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('modalWhatsApp')">&times;</span>
      <h3>Fale conosco pelo WhatsApp</h3>
      <p>Estamos prontos para ajudar você!</p>
      <a href="https://wa.me/5511999999999" target="_blank" class="btn-whatsapp">Abrir WhatsApp</a>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.pt-BR.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.9/dist/inputmask.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- =================== SCRIPT BASE =================== -->
<script>
  $(function() {
    // Evita duplo envio
    $("form[data-etapa]").on("submit", function(){
      const $btn = $(this).find("button[type='submit']").last();
      $btn.prop("disabled", true).text("Enviando...");
    });

    // Inputs menores
    $('input, select, textarea').addClass('form-control form-control-sm rounded-3');
    $('select').removeClass('form-control').addClass('form-select');

    // Máscaras
    if (window.Inputmask) {
      if ($("#id_cpf").length)       Inputmask("999.999.999-99").mask("#id_cpf");
      if ($("#id_telefone").length)  Inputmask({ mask: ["(99) 9999-9999", "(99) 99999-9999"], keepStatic: true }).mask("#id_telefone");
      if ($("#id_data_nascimento").length)
        Inputmask("99/99/9999", { placeholder: "DD/MM/AAAA", clearMaskOnLostFocus: false }).mask("#id_data_nascimento");
    }

    // Datepicker
    if ($.fn.datepicker) {
      $('.date').datepicker({
        format: 'dd/mm/yyyy',
        language: 'pt-BR',
        autoclose: true,
        todayHighlight: true
      });
    }

    // Modais
    window.openModal = function(id) { $('#' + id).addClass('show'); };
    window.closeModal = function(id) { $('#' + id).removeClass('show'); };
    $(window).on('click', function(e) { if ($(e.target).hasClass('modal')) closeModal(e.target.id); });
    $(window).on('keydown', function(e) {
      if (e.key === 'Escape') $('.modal.show').each(function(){ closeModal(this.id); });
    });

    // Ícones nos telefones
    function decorateWithIcon($input, iconClass){
      if(!$input.length || $input.closest('.input-group').length) return;
      const $wrap = $('<div class="input-group input-group-sm"><span class="input-group-text"><i class="'+iconClass+'"></i></span></div>');
      $input.addClass('form-control');
      $input.after($wrap);
      $wrap.append($input);
    }
    decorateWithIcon($('#id_telefone'), 'fa-solid fa-phone');

    function maskTelefone($els){
      if (window.Inputmask) {
        Inputmask({ mask: ["(99) 9999-9999", "(99) 99999-9999"], keepStatic: true }).mask($els);
      }
    }

    // ======= REMOVER (garantia) campos não desejados =======
    const camposRemover = [
      '#id_ja_e_campista',
      '#id_nome_conjuge',
      '#id_conjuge_inscrito',
      // variações de "Outra pastoral ou movimento"
      '#id_outra_pastoral_ou_movimento',
      '#id_outra_pastoral',
      '#id_outro_movimento',
      '#id_pastoral_movimento_outro',
      '#id_pastoral_outro',
      '#id_movimento_outro'
    ];
    camposRemover.forEach(sel=>{
      const $el = $(sel);
      if($el.length){
        const $blk = $el.closest('.form-insc-field, .mb-2, .form-group, div');
        $blk.remove();
      }
    });

    // Fallback: remover pelo texto do label (se vier com outro name)
    $('.form-insc-field').each(function(){
      const txt = $(this).text().toLowerCase();
      if (txt.includes('outra pastoral') || txt.includes('outro movimento') || txt.includes('pastoral (outro)') || txt.includes('movimento (outro)')) {
        $(this).remove();
      }
    });

    // ======= Saúde: condicionais =======
    function toggleCondicionais() {
      const is = (sel, val) => $(sel).val && $(sel).val() === val;

      if ($("#id_problema_saude").length)
        $("#id_qual_problema_saude").closest("p,div,.mb-3,.form-insc-field").toggle(is("#id_problema_saude","sim"));
      if ($("#id_medicamento_controlado").length){
        const show = is("#id_medicamento_controlado","sim");
        $("#id_qual_medicamento_controlado").closest("p,div,.mb-3,.form-insc-field").toggle(show);
        $("#id_protocolo_administracao").closest("p,div,.mb-3,.form-insc-field").toggle(show);
      }
      if ($("#id_mobilidade_reduzida").length)
        $("#id_qual_mobilidade_reduzida").closest("p,div,.mb-3,.form-insc-field").toggle(is("#id_mobilidade_reduzida","sim"));
      if ($("#id_alergia_alimento").length)
        $("#id_qual_alergia_alimento").closest("p,div,.mb-3,.form-insc-field").toggle(is("#id_alergia_alimento","sim"));
      if ($("#id_alergia_medicamento").length)
        $("#id_qual_alergia_medicamento").closest("p,div,.mb-3,.form-insc-field").toggle(is("#id_alergia_medicamento","sim"));
    }
    $("#id_problema_saude, #id_medicamento_controlado, #id_mobilidade_reduzida, #id_alergia_alimento, #id_alergia_medicamento")
      .on("change", toggleCondicionais);
    toggleCondicionais();

    // ======= Campos de filhos dinâmicos =======
    $("#id_qtd_filhos").on("change", function() {
      const qtd = parseInt($(this).val(), 10) || 0;
      const container = $("#filhos_campos").empty();

      for (let i = 1; i <= qtd; i++) {
        const bloco = $(`
          <div class="campo-filho">
            <h6 class="mb-2">Filho ${i}</h6>
            <div class="row g-2">
              <div class="col-md-6">
                <label>Nome</label>
                <input type="text" name="filho_${i}_nome" class="form-control init-cap nome-like">
              </div>
              <div class="col-md-3">
                <label>Idade</label>
                <input type="number" name="filho_${i}_idade" class="form-control">
              </div>
              <div class="col-md-6">
                <label>Telefone</label>
                <input type="text" name="filho_${i}_telefone" class="form-control telefone-filho">
              </div>
            </div>
          </div>
        `);
        container.append(bloco);
      }

      $(".telefone-filho").each(function(){ decorateWithIcon($(this), 'fa-solid fa-phone'); });
      maskTelefone($("#filhos_campos .telefone-filho"));
      aplicarTitleCase(); // reanexa listeners
      aplicarInitCap();   // inicial maiúscula nos novos
    });

    // ======= CEP / ViaCEP =======
    if (window.Inputmask && $("#id_cep").length) Inputmask("99999-999").mask("#id_cep");
    async function preencherEnderecoPorCEP(cep) {
      const cepNum = (cep || "").replace(/\D/g, "");
      if (cepNum.length !== 8) { limpaEndereco(); return; }
      try {
        const resp = await fetch(`https://viacep.com.br/ws/${cepNum}/json/`);
        if (!resp.ok) throw new Error("Falha ao consultar CEP");
        const data = await resp.json();
        if (data.erro) { limpaEndereco(); return; }

        $("#id_endereco").val(data.logradouro || "");
        $("#id_bairro").val(data.bairro || "");
        $("#id_cidade").val(data.localidade || "");
        $("#id_estado").val((data.uf || "").toUpperCase());
      } catch (e) {
        limpaEndereco();
      }
    }
    function limpaEndereco() { $("#id_endereco, #id_bairro, #id_cidade, #id_estado").val(""); }
    let cepTimer = null;
    $("#id_cep")
      .on("blur", function () { preencherEnderecoPorCEP(this.value); })
      .on("keyup", function () {
        const val = this.value;
        clearTimeout(cepTimer);
        cepTimer = setTimeout(() => {
          const digits = (val || "").replace(/\D/g, "");
          if (digits.length === 8) preencherEnderecoPorCEP(val);
        }, 300);
      });

    // ======= TITLE CASE (nomes) + impedir tudo MAIÚSCULO =======
    const excecoes = new Set(["da","de","do","das","dos","e","a","o","as","os","di","du"]);
    function toTitleCasePTBR(s){
      s = (s||"").toLowerCase().replace(/\s+/g," ").trim();
      return s.split(" ").map((w,i)=> i>0 && excecoes.has(w) ? w : w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
    }
    function normalizaNome(el){
      const v = el.value || "";
      if(!v) return;
      const base = (v.length >= 3 && v === v.toUpperCase()) ? v.toLowerCase() : v;
      const novo = toTitleCasePTBR(base);
      if(novo !== v) el.value = novo;
    }
    function aplicarTitleCase(){
      const seletores = [
        "#id_nome",
        "input[name='contato_emergencia_nome']",
        "input[name='responsavel_2_nome']",
        "[name^='filho_'][name$='_nome']"
      ];
      $(seletores.join(",")).off(".tc").on("input.tc blur.tc", function(){
        normalizaNome(this);
      });
    }
    aplicarTitleCase();

    // Protege colagem TODO CAPS em nomes
    $(document).on("paste", "#id_nome, input[name='contato_emergencia_nome'], input[name='responsavel_2_nome'], [name^='filho_'][name$='_nome']",
      function(e){
        e.preventDefault();
        const text = (e.originalEvent || e).clipboardData.getData('text/plain') || "";
        const norm = toTitleCasePTBR(text);
        document.execCommand('insertText', false, norm);
      }
    );

    // ======= Inicial Maiúscula (demais campos textuais) =======
    function aplicarInitCap(){
      $('input[type="text"], textarea')
        .not('#id_email, [name="email"], #id_cpf, [name="cpf"], #id_telefone, [name="telefone"], #id_estado, [name="estado"], #id_numero, [name="numero"]')
        .addClass('init-cap')
        .off('.icap')
        .on('input.icap blur.icap', function(){
          const v = this.value || '';
          if (!v) return;
          const novo = v.charAt(0).toUpperCase() + v.slice(1);
          if (novo !== v) this.value = novo;
        });
    }
    aplicarInitCap();

    // ====== FOTO DO CASAL (somente etapa 2) ======
    (function(){
      const etapa = parseInt($("form[data-etapa]").attr("data-etapa") || "1", 10);
      const $file = $("input[name='foto_casal']");
      const $preview = $("#preview-foto-casal");

      if (!$file.length) return;
      $file.attr("accept","image/*");
      if (etapa === 2) $file.prop("required", true);

      $file.on("change", function(){
        const f = this.files && this.files[0];
        if (!f) { $preview.hide(); return; }
        if (!f.type.startsWith("image/")) { this.value=""; $preview.hide(); return; }
        const reader = new FileReader();
        reader.onload = e => { $preview.attr("src", e.target.result).show(); };
        reader.readAsDataURL(f);
      });
    })();
  });
</script>

<!-- =================== Organização do bloco de saúde (opcional) =================== -->
<script>
  $(function () {
    const $form = $("form[data-etapa]");
    if (!$form.length) return;

    if (!$("#fieldset-saude").length) {
      $form.append(`
        <fieldset id="fieldset-saude" class="mt-3">
          <legend>Dados de Saúde</legend>
          <div class="alert alert-warning" role="alert">
            <strong>Atenção:</strong> preencha todas as informações de saúde com <u>exatidão</u>.
          </div>
          <div id="bloco-saude" class="row g-3"></div>
        </fieldset>
      `);
    }

    const $destSaude = $("#bloco-saude");
    const healthIds = [
      "id_problema_saude","id_qual_problema_saude",
      "id_medicamento_controlado","id_qual_medicamento_controlado","id_protocolo_administracao",
      "id_mobilidade_reduzida","id_qual_mobilidade_reduzida",
      "id_alergia_alimento","id_qual_alergia_alimento",
      "id_alergia_medicamento","id_qual_alergia_medicamento",
      "id_diabetes","id_pressao_alta","id_tipo_sanguineo"
    ];

    function moveToSaude(id){
      const $el = $("#"+id);
      if (!$el.length || $el.closest("#bloco-saude").length) return;
      let $block = $el.closest(".col-md-6, .mb-2, .form-group, p, .form-check, div").first();
      if (!$block.length) { $block = $("<div class='col-md-6 mb-2'></div>").append($el); }
      if (!$block.hasClass("col-md-6")) $block.addClass("col-md-6");
      $block.appendTo($destSaude);
    }
    healthIds.forEach(moveToSaude);

    function toggleCondicionaisSaude() {
      const showIf = (condSel, value, targetSel) => {
        if (!$(condSel).length || !$(targetSel).length) return;
        $(targetSel).closest(".col-md-6, p,div,.mb-3,.form-group")
          .toggle($(condSel).val() === value);
      };
      showIf("#id_problema_saude","sim","#id_qual_problema_saude");
      showIf("#id_medicamento_controlado","sim","#id_qual_medicamento_controlado");
      showIf("#id_medicamento_controlado","sim","#id_protocolo_administracao");
      showIf("#id_mobilidade_reduzida","sim","#id_qual_mobilidade_reduzida");
      showIf("#id_alergia_alimento","sim","#id_qual_alergia_alimento");
      showIf("#id_alergia_medicamento","sim","#id_qual_alergia_medicamento");
    }

    $("#id_problema_saude, #id_medicamento_controlado, #id_mobilidade_reduzida, #id_alergia_alimento, #id_alergia_medicamento")
      .off("change._saude_final").on("change._saude_final", toggleCondicionaisSaude);
    toggleCondicionaisSaude();

    const $submit = $form.find("button[type='submit']").last();
    $form.append($submit);
  });
</script>

</body>
</html>
