{% load static %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>{{ grupo.nome }} ‚Äî {{ evento.nome }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --g1:#0b1020; --g2:#111a3a; --base-font:14px; }
    html{ font-size: var(--base-font); }
    body{ background:#f6f8fb; color:var(--ink); }
    .nav-pro{ background:linear-gradient(90deg,var(--g1),var(--g2)); }
    .navbar .btn{ font-size:.85rem; padding:.35rem .6rem; }
    .navbar-brand{ font-size:1rem; }
    .sidebar-card{ border:1px solid #e5e7eb; border-radius:.9rem; background:#fff; box-shadow:0 10px 24px rgba(17,24,39,.04); }
    .nav-title{ margin:6px 10px 8px; font-size:.75rem; color:var(--muted); text-transform:uppercase; letter-spacing:.06em; }
    .nav-list{ list-style:none; padding:6px; margin:0; }
    .nav-list a{ display:flex; gap:.5rem; align-items:center; padding:.55rem .6rem; border-radius:.6rem; color:var(--ink); text-decoration:none; }
    .nav-list a:hover{ background:#eef2f7; }
    .nav-item.is-active a{ background:#e7efff; border:1px solid #cfe0ff; }
    .card-clean{ border:1px solid #e5e7eb; border-radius:.9rem; background:#fff; box-shadow:0 10px 24px rgba(17,24,39,.08); }
    .sec-title{ font-size:.9rem; color:var(--muted); text-transform:uppercase; letter-spacing:.04em; margin:0 0 .75rem; font-weight:700; }
    .list-hover li:hover{ background:#f8fafc; }

    /* ====== A√á√ïES COMPACTAS ====== */
    .actions{
      display:flex; align-items:center; gap:6px;
      white-space:nowrap; /* evita quebrar linha e deformar */
      justify-content:flex-end;
      min-width: 230px;
    }
    .btn-icon{
      --pad-y: .28rem; --pad-x: .45rem; --fs: .8rem;
      padding: var(--pad-y) var(--pad-x);
      font-size: var(--fs);
      line-height: 1;
      display:inline-flex; align-items:center; gap:.35rem;
    }
    .btn-icon i{ font-size:.9em; }
    .btn-move-select{
      width: 160px; min-width:160px; max-width:160px;
    }
    @media (max-width: 576px){
      .actions{ flex-wrap:wrap; white-space:normal; gap:8px }
      .btn-move-select{ width:100%; min-width:0; max-width:none; }
    }

    /* cores leg√≠veis nos estados */
    .btn-add{ --bs-btn-bg:#16a34a; --bs-btn-border-color:#16a34a; --bs-btn-hover-bg:#15803d; --bs-btn-hover-border-color:#15803d; --bs-btn-color:#fff; }
    .btn-remove{ --bs-btn-bg:#ef4444; --bs-btn-border-color:#ef4444; --bs-btn-hover-bg:#dc2626; --bs-btn-hover-border-color:#dc2626; --bs-btn-color:#fff; }
    .btn-move{ --bs-btn-bg:#2563eb; --bs-btn-border-color:#2563eb; --bs-btn-hover-bg:#1d4ed8; --bs-btn-hover-border-color:#1d4ed8; --bs-btn-color:#fff; }

    /* evita ‚Äúpular‚Äù vertical do item ao trocar bot√µes */
    .list-group-item{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .list-group-item > div:first-child{ min-width: 0; } /* permite truncar texto */
    .list-group-item .fw-semibold{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 42vw; }
    @media (min-width: 992px){ .list-group-item .fw-semibold{ max-width: 420px; } }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar nav-pro navbar-dark">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{% url 'inscricoes:admin_paroquia_painel' %}">Painel da Par√≥quia</a>
    <div class="d-flex align-items-center gap-2 ms-auto">
      <a class="btn btn-sm btn-light" href="{% url 'inscricoes:grupos_evento_home' evento.id %}">‚Üê Voltar para Grupos</a>
    </div>
  </div>
</nav>

<main class="container py-3 py-lg-4">
  <div class="row g-3">

    <!-- SIDEBAR -->
    <aside class="col-lg-3">
      <div class="sidebar-card p-2">
        <div class="nav-title">Navega√ß√£o</div>
        <ul class="nav-list">
          <li class="nav-item"><a href="{% url 'inscricoes:admin_paroquia_painel' %}">üè† <span>Dashboard</span></a></li>
          <li class="nav-item"><a href="{% url 'inscricoes:admin_paroquia_eventos' evento.paroquia.id %}">üóÇÔ∏è <span>Eventos</span></a></li>
          <li class="nav-item"><a href="{% url 'inscricoes:grupos_evento_home' evento.id %}">üë• <span>Grupos/Fam√≠lias</span></a></li>
          <li class="nav-item is-active"><a href="{{ request.path }}">‚úèÔ∏è <span>Editar Grupo</span></a></li>
        </ul>
      </div>
    </aside>

    <!-- CONTE√öDO -->
    <section class="col-lg-9">

      <!-- CABE√áALHO + FORM -->
      <div class="card-clean p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <h1 class="h6 m-0">Editar Grupo/Fam√≠lia</h1>
          <span class="badge rounded-pill bg-light text-dark">{{ evento.nome }}</span>
        </div>
        <hr class="my-3">
        <form method="post" class="vstack gap-3">
          {% csrf_token %}
          {{ form.non_field_errors }}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nome</label>
              {{ form.nome }}
              <div class="text-danger small">{{ form.nome.errors }}</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Cor (cat√°logo)</label>
              {{ form.cor_nome }}
            </div>
            <div class="col-12">
              <label class="form-label">Descri√ß√£o (opcional)</label>
              {{ form.descricao }}
            </div>
          </div>
          <div>
            <button class="btn btn-primary btn-sm"><i class="fa-solid fa-save"></i> Salvar</button>
            <a class="btn btn-light btn-sm" href="{% url 'inscricoes:grupos_evento_home' evento.id %}">Cancelar</a>
          </div>
        </form>
      </div>

      <!-- MEMBROS / ADICIONAR -->
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card-clean p-3 h-100">
            <h2 class="sec-title"><i class="fa-solid fa-user-group me-1"></i> Membros do grupo</h2>
            <ul id="lista-membros" class="list-group list-hover">
              {% for a in membros %}
              <li class="list-group-item">
                <div>
                  <div class="fw-semibold">{{ a.inscricao.participante.nome }}</div>
                  <div class="small text-muted text-truncate">{{ a.inscricao.participante.email }} ‚Ä¢ {{ a.inscricao.participante.cpf }}</div>
                </div>
                <div class="actions">
                  <select class="form-select form-select-sm btn-move-select mover-select" data-inscricao="{{ a.inscricao.id }}">
                    <option value="">Mover para...</option>
                    {% for g in outros_grupos %}
                      <option value="{{ g.id }}">{{ g.nome }}</option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-remove btn-icon btn-toggle"
                          data-bs-toggle="tooltip" data-bs-title="Remover do grupo"
                          data-inscricao="{{ a.inscricao.id }}" data-action="remove">
                    <i class="fa-solid fa-user-minus"></i>
                  </button>
                </div>
              </li>
              {% empty %}
              <li class="list-group-item text-muted">Nenhum membro neste grupo.</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card-clean p-3 h-100">
            <h2 class="sec-title"><i class="fa-solid fa-person-circle-plus me-1"></i> Adicionar pessoas</h2>
            <input id="busca" class="form-control form-control-sm mb-2" placeholder="Digite nome, e-mail ou CPF...">
            <div class="small text-muted mb-2">Resultados (at√© 50)</div>
            <ul id="lista-busca" class="list-group list-hover"></ul>
          </div>
        </div>
      </div>

    </section>
  </div>
</main>

<script>
  // -------- CSRF ----------
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // -------- BUSCA (debounce) ----------
  const busca = document.getElementById("busca");
  const listaBusca = document.getElementById("lista-busca");
  let t = null;

  function renderResultados(items) {
    listaBusca.innerHTML = "";
    if (!items.length) {
      listaBusca.innerHTML = '<li class="list-group-item text-muted">Nenhum resultado.</li>';
      return;
    }
    items.forEach(it => {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex align-items-center justify-content-between";
      li.innerHTML = `
        <div>
          <div class="fw-semibold text-truncate" style="max-width:42vw">${it.nome}</div>
          <div class="small text-muted text-truncate">${it.email} ‚Ä¢ ${it.cpf}</div>
        </div>
        <div class="actions">
          <button class="btn ${it.grupo_id ? 'btn-remove' : 'btn-add'} btn-icon btn-toggle"
                  data-bs-toggle="tooltip"
                  data-bs-title="${it.grupo_id ? 'Remover do grupo atual' : 'Adicionar ao grupo'}"
                  data-inscricao="${it.inscricao_id}"
                  data-action="${it.grupo_id ? 'remove' : 'add'}">
            <i class="fa-solid ${it.grupo_id ? 'fa-user-minus' : 'fa-user-plus'}"></i>
          </button>
          <select class="form-select form-select-sm btn-move-select mover-select" data-inscricao="${it.inscricao_id}">
            <option value="">Mover para...</option>
            {% for g in outros_grupos %}
              <option value="{{ g.id }}">{{ g.nome }}</option>
            {% endfor %}
          </select>
        </div>
      `;
      listaBusca.appendChild(li);
    });
    enableTooltips();
  }

  function buscar(q) {
    const url = "{% url 'inscricoes:grupos_buscar_inscritos' evento.id %}?q=" + encodeURIComponent(q || "");
    fetch(url, {headers: {"X-Requested-With": "XMLHttpRequest"}})
      .then(r => r.json())
      .then(data => renderResultados(data.results || []))
      .catch(() => { listaBusca.innerHTML = '<li class="list-group-item text-danger">Falha ao buscar.</li>'; });
  }

  busca.addEventListener("input", (e) => {
    clearTimeout(t);
    t = setTimeout(() => buscar(e.target.value), 300);
  });

  // -------- TOGGLE ADD/REMOVE ----------
  function toggleMembro(inscricaoId, action, btn) {
    const url = "{% url 'inscricoes:grupo_toggle_membro' grupo.id evento.id %}";
    const fd = new FormData();
    fd.append("inscricao_id", inscricaoId);
    fetch(url, {
      method: "POST",
      headers: {"X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest"},
      body: fd
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) return;
      // atualiza √≠cone/estilo no resultado de busca
      if (btn) {
        const adding = data.action === "added";
        btn.classList.toggle("btn-add", !adding);
        btn.classList.toggle("btn-remove", adding);
        btn.dataset.action = adding ? "remove" : "add";
        btn.innerHTML = `<i class="fa-solid ${adding ? 'fa-user-minus' : 'fa-user-plus'}"></i>`;
        btn.setAttribute("data-bs-title", adding ? "Remover do grupo atual" : "Adicionar ao grupo");
        enableTooltips();
      }
      recarregarMembros();
    });
  }

  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".btn-toggle");
    if (btn) {
      const inscricaoId = btn.dataset.inscricao;
      const action = btn.dataset.action;
      toggleMembro(inscricaoId, action, btn);
    }
  });

  // -------- MOVER ----------
  function recarregarMembros() {
    fetch(window.location.href, {headers: {"X-Requested-With": "XMLHttpRequest"}})
      .then(r => r.text())
      .then(html => {
        const tmp = document.createElement("div");
        tmp.innerHTML = html;
        const novaLista = tmp.querySelector("#lista-membros");
        if (novaLista) document.getElementById("lista-membros").innerHTML = novaLista.innerHTML;
        enableTooltips();
      });
  }

  document.addEventListener("change", (e) => {
    const sel = e.target.closest(".mover-select");
    if (sel && sel.value) {
      const inscricaoId = sel.dataset.inscricao;
      const targetGrupoId = sel.value;
      const fd = new FormData();
      fd.append("inscricao_id", inscricaoId);
      fd.append("evento_id", "{{ evento.id }}");
      fd.append("target_grupo_id", targetGrupoId);

      fetch("{% url 'inscricoes:grupo_mover_membro' %}", {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest"},
        body: fd
      })
      .then(r => r.json())
      .then(() => {
        sel.value = "";
        recarregarMembros();
      });
    }
  });

  function enableTooltips(){
    const list = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    list.forEach(el => new bootstrap.Tooltip(el, {container:'body'}));
  }

  // Inicial
  buscar("");
  document.addEventListener("DOMContentLoaded", enableTooltips);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
